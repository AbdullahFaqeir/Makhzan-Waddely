{"version":3,"file":"notification-settings-page-OqeGGTFt.js","sources":["../../../common/foundation/resources/client/notifications/subscriptions/requests/update-notification-settings.ts","../../../common/foundation/resources/client/notifications/subscriptions/notification-settings-page.tsx"],"sourcesContent":["import {useMutation} from '@tanstack/react-query';\nimport {BackendResponse} from '@common/http/backend-response/backend-response';\nimport {toast} from '@ui/toast/toast';\nimport {apiClient, queryClient} from '@common/http/query-client';\nimport {message} from '@ui/i18n/message';\nimport {showHttpErrorToast} from '@common/http/show-http-error-toast';\n\ninterface Response extends BackendResponse {\n  //\n}\n\ntype UpdateNotificationSettingsPayload = {\n  notif_id: string;\n  channels: Record<string, boolean>;\n}[];\n\nfunction UpdateNotificationSettings(\n  payload: UpdateNotificationSettingsPayload,\n): Promise<Response> {\n  return apiClient\n    .put('notifications/me/subscriptions', {selections: payload})\n    .then(r => r.data);\n}\n\nexport function useUpdateNotificationSettings() {\n  return useMutation({\n    mutationFn: (payload: UpdateNotificationSettingsPayload) =>\n      UpdateNotificationSettings(payload),\n    onSuccess: () => {\n      toast(message('Updated preferences'));\n      queryClient.invalidateQueries({queryKey: ['notification-subscriptions']});\n    },\n    onError: err => showHttpErrorToast(err),\n  });\n}\n","import {useSuspenseQuery} from '@tanstack/react-query';\nimport {Button} from '@ui/buttons/button';\nimport {Checkbox} from '@ui/forms/toggle/checkbox';\nimport {message} from '@ui/i18n/message';\nimport {Trans} from '@ui/i18n/trans';\nimport {toast} from '@ui/toast/toast';\nimport {produce} from 'immer';\nimport {Fragment, useState} from 'react';\nimport {Navbar} from '../../ui/navigation/navbar/navbar';\nimport {NotificationSubscriptionGroup} from './notification-subscription';\nimport {notificationSubscriptionsQueryOptions} from './requests/notification-subscriptions';\nimport {useUpdateNotificationSettings} from './requests/update-notification-settings';\n\ntype Selection = Record<string, ChannelSelection>;\n\n// {email: true, mobile: true, browser: false}\ntype ChannelSelection = Record<string, boolean>;\n\nexport function Component() {\n  return (\n    <div className=\"min-h-screen bg\">\n      <Navbar\n        color=\"bg\"\n        darkModeColor=\"bg-elevated\"\n        menuPosition=\"notifications-page\"\n      />\n      <div className=\"container mx-auto my-20 px-10 md:my-40 md:px-20\">\n        <div className=\"rounded-panel border bg-elevated px-20 pb-30 pt-20 shadow-sm\">\n          <NotificationSettings />\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport function NotificationSettings() {\n  const updateSettings = useUpdateNotificationSettings();\n  const {data} = useSuspenseQuery(notificationSubscriptionsQueryOptions);\n  const [selection, setSelection] = useState<Selection>(() => {\n    const initialSelection: Selection = {};\n    const initialValue: ChannelSelection = {};\n    data.available_channels.forEach(channel => {\n      initialValue[channel] = false;\n    });\n\n    data.subscriptions.forEach(group => {\n      group.subscriptions.forEach(subscription => {\n        const backendValue = data.user_selections.find(\n          s => s.notif_id === subscription.notif_id,\n        );\n        initialSelection[subscription.notif_id] = backendValue?.channels || {\n          ...initialValue,\n        };\n      });\n    });\n\n    return initialSelection;\n  });\n\n  return (\n    <Fragment>\n      {data.subscriptions.map(group => (\n        <div key={group.group_name} className=\"mb-10 text-sm\">\n          <GroupRow\n            key={group.group_name}\n            group={group}\n            allChannels={data?.available_channels}\n            selection={selection}\n            setSelection={setSelection}\n          />\n          {group.subscriptions.map(subscription => (\n            <SubscriptionRow\n              key={subscription.notif_id}\n              subscription={subscription}\n              selection={selection}\n              setSelection={setSelection}\n              allChannels={data?.available_channels}\n            />\n          ))}\n        </div>\n      ))}\n      <Button\n        className=\"ml-10 mt-20\"\n        variant=\"flat\"\n        color=\"primary\"\n        disabled={updateSettings.isPending}\n        onClick={() => {\n          updateSettings.mutate(\n            Object.entries(selection).map(([notifId, channels]) => {\n              return {notif_id: notifId, channels};\n            }),\n          );\n        }}\n      >\n        <Trans message=\"Update preferences\" />\n      </Button>\n    </Fragment>\n  );\n}\n\ninterface GroupRowProps {\n  group: NotificationSubscriptionGroup;\n  allChannels: string[];\n  selection: Selection;\n  setSelection: (value: Selection) => void;\n}\nfunction GroupRow({\n  group,\n  allChannels,\n  selection,\n  setSelection,\n}: GroupRowProps) {\n  const toggleAll = (channelName: string, value: boolean) => {\n    const nextState = produce(selection, draftState => {\n      Object.keys(selection).forEach(notifId => {\n        draftState[notifId][channelName] = value;\n      });\n    });\n    setSelection(nextState);\n  };\n\n  const checkboxes = (\n    <div className=\"ml-auto flex items-center gap-40 max-md:hidden\">\n      {allChannels.map(channelName => {\n        const allSelected = Object.values(selection).every(s => s[channelName]);\n        const someSelected =\n          !allSelected && Object.values(selection).some(s => s[channelName]);\n        return (\n          <Checkbox\n            key={channelName}\n            orientation=\"vertical\"\n            isIndeterminate={someSelected}\n            checked={allSelected}\n            onChange={async e => {\n              if (channelName === 'browser') {\n                const granted = await requestBrowserPermission();\n                toggleAll(channelName, !granted ? false : !allSelected);\n              } else {\n                toggleAll(channelName, !allSelected);\n              }\n            }}\n          >\n            <Trans message={channelName} />\n          </Checkbox>\n        );\n      })}\n    </div>\n  );\n\n  return (\n    <div className=\"flex items-center border-b p-10\">\n      <div className=\"font-semibold\">\n        <Trans message={group.group_name} />\n      </div>\n      {checkboxes}\n    </div>\n  );\n}\n\ninterface SubscriptionRowProps {\n  subscription: {name: string; notif_id: string};\n  allChannels: string[];\n  selection: Selection;\n  setSelection: (value: Selection) => void;\n}\nfunction SubscriptionRow({\n  subscription,\n  allChannels,\n  selection,\n  setSelection,\n}: SubscriptionRowProps) {\n  const notifId = subscription.notif_id;\n\n  const toggleChannel = (channelName: string, value: boolean) => {\n    const nextState = produce(selection, draftState => {\n      draftState[subscription.notif_id][channelName] = value;\n    });\n    setSelection(nextState);\n  };\n\n  return (\n    <div className=\"items-center border-b py-10 pl-8 pr-10 md:flex md:pl-20\">\n      <div className=\"pb-14 font-semibold md:pb-0 md:font-normal\">\n        <Trans message={subscription.name} />\n      </div>\n      <div className=\"ml-auto flex items-center gap-40\">\n        {allChannels.map(channelName => (\n          <Checkbox\n            key={channelName}\n            orientation=\"vertical\"\n            checked={selection[notifId][channelName]}\n            onChange={async e => {\n              const newValue = !selection[notifId][channelName];\n              if (channelName === 'browser') {\n                const granted = await requestBrowserPermission();\n                toggleChannel(channelName, !granted ? false : newValue);\n              } else {\n                toggleChannel(channelName, newValue);\n              }\n            }}\n            aria-label={channelName}\n          >\n            <div className=\"md:invisible md:h-0\">\n              <Trans message={channelName} />\n            </div>\n          </Checkbox>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction requestBrowserPermission(): Promise<boolean> {\n  if (Notification.permission === 'granted') {\n    return Promise.resolve(true);\n  }\n  if (Notification.permission === 'denied') {\n    toast.danger(\n      message(\n        'Notifications blocked. Please enable them for this site from browser settings.',\n      ),\n    );\n    return Promise.resolve(false);\n  }\n  return Notification.requestPermission().then(permission => {\n    return permission === 'granted';\n  });\n}\n"],"names":["UpdateNotificationSettings","payload","apiClient","r","useUpdateNotificationSettings","useMutation","toast","message","queryClient","err","showHttpErrorToast","Component","jsxs","jsx","Navbar","NotificationSettings","updateSettings","data","useSuspenseQuery","notificationSubscriptionsQueryOptions","selection","setSelection","useState","initialSelection","initialValue","channel","group","subscription","backendValue","s","Fragment","GroupRow","SubscriptionRow","Button","notifId","channels","Trans","allChannels","toggleAll","channelName","value","nextState","produce","draftState","checkboxes","allSelected","someSelected","Checkbox","e","granted","requestBrowserPermission","toggleChannel","newValue","permission"],"mappings":"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"}