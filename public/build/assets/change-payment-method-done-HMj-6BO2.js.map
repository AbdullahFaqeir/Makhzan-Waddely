{"version":3,"file":"change-payment-method-done-HMj-6BO2.js","sources":["../../../common/foundation/resources/client/billing/billing-page/change-payment-method/change-payment-method-done.tsx"],"sourcesContent":["import {apiClient} from '@common/http/query-client';\nimport {useNavigate} from '@common/ui/navigation/use-navigate';\nimport {loadStripe, SetupIntent} from '@stripe/stripe-js';\nimport {message} from '@ui/i18n/message';\nimport {useSettings} from '@ui/settings/use-settings';\nimport {useEffect, useRef, useState} from 'react';\nimport {useSearchParams} from 'react-router';\nimport {\n  BillingRedirectMessage,\n  BillingRedirectMessageConfig,\n} from '../../billing-redirect-message';\nimport {invalidateBillingUserQuery} from '../use-billing-user';\n\nconst previousUrl = '/billing';\n\nexport function Component() {\n  const {\n    billing: {stripe_public_key},\n  } = useSettings();\n  const navigate = useNavigate();\n\n  const [params] = useSearchParams();\n  const clientSecret = params.get('setup_intent_client_secret');\n\n  const [messageConfig, setMessageConfig] =\n    useState<BillingRedirectMessageConfig>();\n\n  const stripeInitiated = useRef(false);\n\n  useEffect(() => {\n    if (stripeInitiated.current || !clientSecret) return;\n    loadStripe(stripe_public_key!).then(stripe => {\n      if (!stripe) {\n        setMessageConfig(getRedirectMessageConfig());\n        return;\n      }\n      stripe.retrieveSetupIntent(clientSecret).then(({setupIntent}) => {\n        if (setupIntent?.status === 'succeeded') {\n          changeDefaultPaymentMethod(setupIntent.payment_method as string).then(\n            () => {\n              invalidateBillingUserQuery();\n            },\n          );\n        }\n        setMessageConfig(getRedirectMessageConfig(setupIntent?.status));\n      });\n    });\n    stripeInitiated.current = true;\n  }, [stripe_public_key, clientSecret]);\n\n  if (!clientSecret) {\n    navigate(previousUrl);\n    return null;\n  }\n\n  return <BillingRedirectMessage config={messageConfig} />;\n}\n\nfunction getRedirectMessageConfig(\n  status?: SetupIntent.Status,\n): BillingRedirectMessageConfig {\n  switch (status) {\n    case 'succeeded':\n      return {\n        ...redirectMessageDefaults,\n        message: message('Payment method changed successfully!'),\n        status: 'success',\n      };\n    case 'processing':\n      return {\n        ...redirectMessageDefaults,\n        message: message(\n          \"Your request is processing. We'll update you when your payment method is confirmed.\",\n        ),\n        status: 'success',\n      };\n    case 'requires_payment_method':\n      return {\n        ...redirectMessageDefaults,\n        message: message(\n          'Payment method confirmation failed. Please try another payment method.',\n        ),\n        status: 'error',\n      };\n    default:\n      return {\n        ...redirectMessageDefaults,\n        message: message('Something went wrong'),\n        status: 'error',\n      };\n  }\n}\n\nconst redirectMessageDefaults: Omit<\n  BillingRedirectMessageConfig,\n  'message' | 'status'\n> = {\n  link: previousUrl,\n  buttonLabel: message('Go back'),\n};\n\nfunction changeDefaultPaymentMethod(paymentMethodId: string) {\n  return apiClient.post('billing/stripe/change-default-payment-method', {\n    payment_method_id: paymentMethodId,\n  });\n}\n"],"names":["previousUrl","Component","stripe_public_key","useSettings","navigate","useNavigate","params","useSearchParams","clientSecret","messageConfig","setMessageConfig","useState","stripeInitiated","useRef","useEffect","loadStripe","stripe","getRedirectMessageConfig","setupIntent","changeDefaultPaymentMethod","invalidateBillingUserQuery","jsx","BillingRedirectMessage","status","redirectMessageDefaults","message","paymentMethodId","apiClient"],"mappings":"sSAaA,MAAMA,EAAc,WAEb,SAASC,GAAY,CAC1B,KAAM,CACJ,QAAS,CAAC,kBAAAC,CAAA,CAAiB,EACzBC,EAAA,EACEC,EAAWC,EAAA,EAEX,CAACC,CAAM,EAAIC,EAAA,EACXC,EAAeF,EAAO,IAAI,4BAA4B,EAEtD,CAACG,EAAeC,CAAgB,EACpCC,WAAA,EAEIC,EAAkBC,EAAAA,OAAO,EAAK,EAuBpC,OArBAC,EAAAA,UAAU,IAAM,CACVF,EAAgB,SAAW,CAACJ,IAChCO,EAAWb,CAAkB,EAAE,KAAKc,GAAU,CAC5C,GAAI,CAACA,EAAQ,CACXN,EAAiBO,GAA0B,EAC3C,MACF,CACAD,EAAO,oBAAoBR,CAAY,EAAE,KAAK,CAAC,CAAC,YAAAU,KAAiB,EAC3DA,GAAA,YAAAA,EAAa,UAAW,aAC1BC,EAA2BD,EAAY,cAAwB,EAAE,KAC/D,IAAM,CACJE,EAAA,CACF,CAAA,EAGJV,EAAiBO,EAAyBC,GAAA,YAAAA,EAAa,MAAM,CAAC,CAChE,CAAC,CACH,CAAC,EACDN,EAAgB,QAAU,GAC5B,EAAG,CAACV,EAAmBM,CAAY,CAAC,EAE/BA,EAKEa,EAAAA,IAACC,EAAA,CAAuB,OAAQb,CAAA,CAAe,GAJpDL,EAASJ,CAAW,EACb,KAIX,CAEA,SAASiB,EACPM,EAC8B,CAC9B,OAAQA,EAAA,CACN,IAAK,YACH,MAAO,CACL,GAAGC,EACH,QAASC,EAAQ,sCAAsC,EACvD,OAAQ,SAAA,EAEZ,IAAK,aACH,MAAO,CACL,GAAGD,EACH,QAASC,EACP,qFAAA,EAEF,OAAQ,SAAA,EAEZ,IAAK,0BACH,MAAO,CACL,GAAGD,EACH,QAASC,EACP,wEAAA,EAEF,OAAQ,OAAA,EAEZ,QACE,MAAO,CACL,GAAGD,EACH,QAASC,EAAQ,sBAAsB,EACvC,OAAQ,OAAA,CACV,CAEN,CAEA,MAAMD,EAGF,CACF,KAAMxB,EACN,YAAayB,EAAQ,SAAS,CAChC,EAEA,SAASN,EAA2BO,EAAyB,CAC3D,OAAOC,EAAU,KAAK,+CAAgD,CACpE,kBAAmBD,CAAA,CACpB,CACH"}