{"version":3,"file":"use-active-upload-D5c4dCmN.js","sources":["../../../common/foundation/resources/client/uploads/requests/delete-file-entries.ts","../../../common/foundation/resources/client/uploads/uploader/use-active-upload.ts"],"sourcesContent":["import {useMutation} from '@tanstack/react-query';\nimport {BackendResponse} from '../../http/backend-response/backend-response';\nimport {apiClient} from '../../http/query-client';\nimport {showHttpErrorToast} from '../../http/show-http-error-toast';\n\ninterface Response extends BackendResponse {}\n\ninterface Payload {\n  entryIds?: number[];\n  deleteForever?: boolean;\n  paths?: string[];\n}\n\nfunction deleteFileEntries(payload: Payload): Promise<Response> {\n  return apiClient.post('file-entries/delete', payload).then(r => r.data);\n}\n\nexport function useDeleteFileEntries() {\n  return useMutation({\n    mutationFn: (props: Payload) => deleteFileEntries(props),\n    onError: err => showHttpErrorToast(err),\n  });\n}\n","import {useDeleteFileEntries} from '@common/uploads/requests/delete-file-entries';\nimport {restrictionsFromConfig} from '@common/uploads/uploader/create-file-upload';\nimport {openUploadWindow} from '@ui/utils/files/open-upload-window';\nimport {UploadedFile} from '@ui/utils/files/uploaded-file';\nimport {useCallback, useRef} from 'react';\nimport {useShallow} from 'zustand/react/shallow';\nimport {useFileUploadStore} from './file-upload-provider';\nimport {UploadStrategyConfig} from './strategy/upload-strategy';\n\ninterface DeleteEntryProps {\n  onSuccess: () => void;\n  entryPath?: string;\n}\n\nexport function useActiveUpload() {\n  const deleteFileEntries = useDeleteFileEntries();\n\n  // use ref for setting ID to avoid extra renders, zustand selector\n  // will pick up changed selector on first progress event\n  const uploadIdRef = useRef<string>(null);\n\n  const uploadSingle = useFileUploadStore(s => s.uploadSingle);\n  const _abortUpload = useFileUploadStore(s => s.abortUpload);\n  const updateFileUpload = useFileUploadStore(s => s.updateFileUpload);\n  const activeUpload = useFileUploadStore(\n    useShallow(s =>\n      uploadIdRef.current ? s.fileUploads.get(uploadIdRef.current) : null,\n    ),\n  );\n\n  const uploadFile = useCallback(\n    (file: File | UploadedFile, config: UploadStrategyConfig) => {\n      uploadIdRef.current = uploadSingle(file, config);\n    },\n    [uploadSingle],\n  );\n\n  const selectAndUploadFile = useCallback(\n    async (config: UploadStrategyConfig) => {\n      const restrictions = restrictionsFromConfig(config);\n      const files = await openUploadWindow({\n        types: restrictions?.allowedFileTypes,\n      });\n      uploadFile(files[0], config);\n      return files[0];\n    },\n    [uploadFile],\n  );\n\n  const deleteEntry = useCallback(\n    ({onSuccess, entryPath}: DeleteEntryProps) => {\n      const handleSuccess = () => {\n        if (activeUpload) {\n          updateFileUpload(activeUpload.file.id, {\n            ...activeUpload,\n            entry: undefined,\n          });\n        }\n        onSuccess();\n      };\n\n      if (!entryPath && !activeUpload?.entry?.id) {\n        handleSuccess();\n        return;\n      }\n\n      deleteFileEntries.mutate(\n        {\n          paths: entryPath ? [entryPath] : undefined,\n          entryIds: activeUpload?.entry?.id\n            ? [activeUpload?.entry?.id]\n            : undefined,\n          deleteForever: true,\n        },\n        {onSuccess: handleSuccess},\n      );\n    },\n    [deleteFileEntries, activeUpload, updateFileUpload],\n  );\n\n  const abortUpload = useCallback(() => {\n    if (activeUpload) {\n      _abortUpload(activeUpload.file.id);\n    }\n  }, [activeUpload, _abortUpload]);\n\n  return {\n    uploadFile,\n    selectAndUploadFile,\n    percentage: activeUpload?.percentage || 0,\n    uploadStatus: activeUpload?.status,\n    entry: activeUpload?.entry,\n    deleteEntry,\n    isDeletingEntry: deleteFileEntries.isPending,\n    activeUpload,\n    abortUpload,\n  };\n}\n"],"names":["deleteFileEntries","payload","apiClient","useDeleteFileEntries","useMutation","props","err","showHttpErrorToast","useActiveUpload","uploadIdRef","useRef","uploadSingle","useFileUploadStore","s","_abortUpload","updateFileUpload","activeUpload","useShallow","uploadFile","useCallback","file","config","selectAndUploadFile","restrictions","restrictionsFromConfig","files","openUploadWindow","deleteEntry","onSuccess","entryPath","handleSuccess","_a","_b","_c","abortUpload"],"mappings":"sNAaA,SAASA,EAAkBC,EAAqC,CAC9D,OAAOC,EAAU,KAAK,sBAAuBD,CAAO,EAAE,KAAK,GAAK,EAAE,IAAI,CACxE,CAEO,SAASE,GAAuB,CACrC,OAAOC,EAAY,CACjB,WAAaC,GAAmBL,EAAkBK,CAAK,EACvD,QAASC,GAAOC,EAAmBD,CAAG,CAAA,CACvC,CACH,CCRO,SAASE,GAAkB,CAChC,MAAMR,EAAoBG,EAAA,EAIpBM,EAAcC,EAAAA,OAAe,IAAI,EAEjCC,EAAeC,EAAmBC,GAAKA,EAAE,YAAY,EACrDC,EAAeF,EAAmBC,GAAKA,EAAE,WAAW,EACpDE,EAAmBH,EAAmBC,GAAKA,EAAE,gBAAgB,EAC7DG,EAAeJ,EACnBK,EAAWJ,GACTJ,EAAY,QAAUI,EAAE,YAAY,IAAIJ,EAAY,OAAO,EAAI,IAAA,CACjE,EAGIS,EAAaC,EAAAA,YACjB,CAACC,EAA2BC,IAAiC,CAC3DZ,EAAY,QAAUE,EAAaS,EAAMC,CAAM,CACjD,EACA,CAACV,CAAY,CAAA,EAGTW,EAAsBH,EAAAA,YAC1B,MAAOE,GAAiC,CACtC,MAAME,EAAeC,EAAuBH,CAAM,EAC5CI,EAAQ,MAAMC,EAAiB,CACnC,MAAOH,GAAA,YAAAA,EAAc,gBAAA,CACtB,EACD,OAAAL,EAAWO,EAAM,CAAC,EAAGJ,CAAM,EACpBI,EAAM,CAAC,CAChB,EACA,CAACP,CAAU,CAAA,EAGPS,EAAcR,EAAAA,YAClB,CAAC,CAAC,UAAAS,EAAW,UAAAC,KAAiC,WAC5C,MAAMC,EAAgB,IAAM,CACtBd,GACFD,EAAiBC,EAAa,KAAK,GAAI,CACrC,GAAGA,EACH,MAAO,MAAA,CACR,EAEHY,EAAA,CACF,EAEA,GAAI,CAACC,GAAa,GAACE,EAAAf,GAAA,YAAAA,EAAc,QAAd,MAAAe,EAAqB,IAAI,CAC1CD,EAAA,EACA,MACF,CAEA9B,EAAkB,OAChB,CACE,MAAO6B,EAAY,CAACA,CAAS,EAAI,OACjC,UAAUG,EAAAhB,GAAA,YAAAA,EAAc,QAAd,MAAAgB,EAAqB,GAC3B,EAACC,EAAAjB,GAAA,YAAAA,EAAc,QAAd,YAAAiB,EAAqB,EAAE,EACxB,OACJ,cAAe,EAAA,EAEjB,CAAC,UAAWH,CAAA,CAAa,CAE7B,EACA,CAAC9B,EAAmBgB,EAAcD,CAAgB,CAAA,EAG9CmB,EAAcf,EAAAA,YAAY,IAAM,CAChCH,GACFF,EAAaE,EAAa,KAAK,EAAE,CAErC,EAAG,CAACA,EAAcF,CAAY,CAAC,EAE/B,MAAO,CACL,WAAAI,EACA,oBAAAI,EACA,YAAYN,GAAA,YAAAA,EAAc,aAAc,EACxC,aAAcA,GAAA,YAAAA,EAAc,OAC5B,MAAOA,GAAA,YAAAA,EAAc,MACrB,YAAAW,EACA,gBAAiB3B,EAAkB,UACnC,aAAAgB,EACA,YAAAkB,CAAA,CAEJ"}