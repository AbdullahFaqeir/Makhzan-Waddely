{"version":3,"file":"use-social-login-CDvSETdS.js","sources":["../../../common/foundation/resources/client/auth/requests/disconnect-social.ts","../../../common/foundation/resources/client/auth/requests/use-social-login.ts"],"sourcesContent":["import {useMutation} from '@tanstack/react-query';\nimport {BackendResponse} from '../../http/backend-response/backend-response';\nimport {apiClient} from '../../http/query-client';\nimport {showHttpErrorToast} from '../../http/show-http-error-toast';\n\ninterface Response extends BackendResponse {\n  //\n}\n\ninterface Payload {\n  service: string;\n}\n\nexport function useDisconnectSocial() {\n  return useMutation({\n    mutationFn: disconnect,\n    onError: err => showHttpErrorToast(err),\n  });\n}\n\nfunction disconnect(payload: Payload): Promise<Response> {\n  return apiClient\n    .post(`secure/auth/social/${payload.service}/disconnect`, payload)\n    .then(response => response.data);\n}\n","import {\n  getBootstrapData,\n  setBootstrapData,\n} from '@ui/bootstrap-data/bootstrap-data-store';\nimport {useTrans} from '@ui/i18n/use-trans';\nimport {toast} from '@ui/toast/toast';\nimport {useCallback, useState} from 'react';\nimport {useDisconnectSocial} from './disconnect-social';\n\nexport type SocialService = 'google' | 'twitter' | 'facebook' | 'envato';\n\ninterface SocialMessageEvent {\n  status?: 'SUCCESS' | 'ALREADY_LOGGED_IN' | 'REQUEST_PASSWORD' | 'ERROR';\n  callbackData?: {\n    bootstrapData?: string;\n    errorMessage?: string;\n  };\n}\n\nexport function useSocialLogin() {\n  const {trans} = useTrans();\n  const disconnectSocial = useDisconnectSocial();\n\n  const [requestingPassword, setIsRequestingPassword] = useState(false);\n\n  const handleSocialLoginCallback = useCallback(\n    (e: SocialMessageEvent) => {\n      const {status, callbackData} = e;\n      if (!status) return;\n      switch (status.toUpperCase()) {\n        case 'SUCCESS':\n          if (callbackData?.bootstrapData) {\n            setBootstrapData(callbackData.bootstrapData);\n          }\n          return e;\n        case 'REQUEST_PASSWORD':\n          setIsRequestingPassword(true);\n          return e;\n        case 'ERROR':\n          const message: string =\n            callbackData?.errorMessage ||\n            trans({\n              message: 'An error occurred. Please try again later',\n            });\n          toast.danger(message);\n          return e;\n        default:\n          return e;\n      }\n    },\n    [trans, setBootstrapData],\n  );\n\n  return {\n    requestingPassword,\n    setIsRequestingPassword,\n    loginWithSocial: async (serviceName: SocialService) => {\n      const event = await openNewSocialAuthWindow(\n        `secure/auth/social/${serviceName}/login`,\n      );\n      return handleSocialLoginCallback(event);\n    },\n    connectSocial: async (serviceNameOrUrl: SocialService | string) => {\n      const url = serviceNameOrUrl.includes('/')\n        ? serviceNameOrUrl\n        : `secure/auth/social/${serviceNameOrUrl}/connect`;\n      const event = await openNewSocialAuthWindow(url);\n      return handleSocialLoginCallback(event);\n    },\n    disconnectSocial,\n  };\n}\n\nconst windowHeight = 550;\nconst windowWidth = 650;\nlet win: Window | null;\n\nfunction openNewSocialAuthWindow(url: string): Promise<SocialMessageEvent> {\n  const left = window.screen.width / 2 - windowWidth / 2;\n  const top = window.screen.height / 2 - windowHeight / 2;\n\n  return new Promise(resolve => {\n    win = window.open(\n      url,\n      'Authenticate Account',\n      `menubar=0, location=0, toolbar=0, titlebar=0, status=0, scrollbars=1, width=${windowWidth}, height=${windowHeight}, left=${left}, top=${top}`,\n    );\n\n    const channel = new BroadcastChannel('social-auth');\n\n    const messageListener = (e: MessageEvent) => {\n      const baseUrl = getBootstrapData().settings.base_url;\n      if (e.data.type === 'social-auth' && baseUrl.indexOf(e.origin) > -1) {\n        resolve(e.data);\n        channel.removeEventListener('message', messageListener);\n      }\n    };\n\n    channel.addEventListener('message', messageListener);\n\n    // if user closes social login callback without interacting with it, remove message event listener\n    const timer = setInterval(() => {\n      if (!win || win.closed) {\n        clearInterval(timer);\n        resolve({});\n        channel.removeEventListener('message', messageListener);\n      }\n    }, 1000);\n  });\n}\n"],"names":["useDisconnectSocial","useMutation","disconnect","err","showHttpErrorToast","payload","apiClient","response","useSocialLogin","trans","useTrans","disconnectSocial","requestingPassword","setIsRequestingPassword","useState","handleSocialLoginCallback","useCallback","e","status","callbackData","setBootstrapData","message","toast","serviceName","event","openNewSocialAuthWindow","serviceNameOrUrl","url","windowHeight","windowWidth","win","left","top","resolve","channel","messageListener","baseUrl","getBootstrapData","timer"],"mappings":"4FAaO,SAASA,GAAsB,CACpC,OAAOC,EAAY,CACjB,WAAYC,EACZ,QAASC,GAAOC,EAAmBD,CAAG,CAAA,CACvC,CACH,CAEA,SAASD,EAAWG,EAAqC,CACvD,OAAOC,EACJ,KAAK,sBAAsBD,EAAQ,OAAO,cAAeA,CAAO,EAChE,KAAKE,GAAYA,EAAS,IAAI,CACnC,CCLO,SAASC,GAAiB,CAC/B,KAAM,CAAC,MAAAC,CAAA,EAASC,EAAA,EACVC,EAAmBX,EAAA,EAEnB,CAACY,EAAoBC,CAAuB,EAAIC,EAAAA,SAAS,EAAK,EAE9DC,EAA4BC,EAAAA,YAC/BC,GAA0B,CACzB,KAAM,CAAC,OAAAC,EAAQ,aAAAC,CAAA,EAAgBF,EAC/B,GAAKC,EACL,OAAQA,EAAO,cAAY,CACzB,IAAK,UACH,OAAIC,GAAA,MAAAA,EAAc,eAChBC,EAAiBD,EAAa,aAAa,EAEtCF,EACT,IAAK,mBACH,OAAAJ,EAAwB,EAAI,EACrBI,EACT,IAAK,QACH,MAAMI,GACJF,GAAA,YAAAA,EAAc,eACdV,EAAM,CACJ,QAAS,2CAAA,CACV,EACH,OAAAa,EAAM,OAAOD,CAAO,EACbJ,EACT,QACE,OAAOA,CAAA,CAEb,EACA,CAACR,EAAOW,CAAgB,CAAA,EAG1B,MAAO,CACL,mBAAAR,EACA,wBAAAC,EACA,gBAAiB,MAAOU,GAA+B,CACrD,MAAMC,EAAQ,MAAMC,EAClB,sBAAsBF,CAAW,QAAA,EAEnC,OAAOR,EAA0BS,CAAK,CACxC,EACA,cAAe,MAAOE,GAA6C,CACjE,MAAMC,EAAMD,EAAiB,SAAS,GAAG,EACrCA,EACA,sBAAsBA,CAAgB,WACpCF,EAAQ,MAAMC,EAAwBE,CAAG,EAC/C,OAAOZ,EAA0BS,CAAK,CACxC,EACA,iBAAAb,CAAA,CAEJ,CAEA,MAAMiB,EAAe,IACfC,EAAc,IACpB,IAAIC,EAEJ,SAASL,EAAwBE,EAA0C,CACzE,MAAMI,EAAO,OAAO,OAAO,MAAQ,EAAIF,EAAc,EAC/CG,EAAM,OAAO,OAAO,OAAS,EAAIJ,EAAe,EAEtD,OAAO,IAAI,QAAQK,GAAW,CAC5BH,EAAM,OAAO,KACXH,EACA,uBACA,+EAA+EE,CAAW,YAAYD,CAAY,UAAUG,CAAI,SAASC,CAAG,EAAA,EAG9I,MAAME,EAAU,IAAI,iBAAiB,aAAa,EAE5CC,EAAmB,GAAoB,CAC3C,MAAMC,EAAUC,IAAmB,SAAS,SACxC,EAAE,KAAK,OAAS,eAAiBD,EAAQ,QAAQ,EAAE,MAAM,EAAI,KAC/DH,EAAQ,EAAE,IAAI,EACdC,EAAQ,oBAAoB,UAAWC,CAAe,EAE1D,EAEAD,EAAQ,iBAAiB,UAAWC,CAAe,EAGnD,MAAMG,EAAQ,YAAY,IAAM,EAC1B,CAACR,GAAOA,EAAI,UACd,cAAcQ,CAAK,EACnBL,EAAQ,CAAA,CAAE,EACVC,EAAQ,oBAAoB,UAAWC,CAAe,EAE1D,EAAG,GAAI,CACT,CAAC,CACH"}