import{w as _,an as F,ap as P,aH as k,x as n,av as u,cc as m,k as N,e as K,j as e,am as z,T as a,a5 as S,a3 as M,a7 as T,a2 as I,M as A,Q as E,R as q,B as g,cE as H,D as p,ay as U,r as W,J as j,aB as y,ak as G}from"./main-owSUWNVS.js";import{u as V,a as L,G as O,D as J,b as $,c as X}from"./use-datatable-query-CxfVxFSv.js";import{D as Y}from"./datatable-filters-xSZH8rQ_.js";import{a as Z,D as ee,b as se,c as ae}from"./datatable-page-with-header-layout-68nRfBM1.js";import{T as te}from"./table-Bl939KD9.js";import{F as h}from"./formatted-date-dVjFR1LG.js";import{E as ie}from"./Edit-D8nu-GLe.js";import{P as re,a as ne}from"./PlayArrow-FQPt9dV5.js";import{C as f}from"./confirmation-dialog-DdZaouVf.js";import{u as B}from"./use-cancel-subscription-ddnYPbDq.js";import{u as oe}from"./use-resume-subscription-DWoReR-s.js";import{N as le}from"./name-with-avatar-BLPHAx2F.js";import{D as ce}from"./data-table-add-item-button-C867XSQv.js";import{D as Q}from"./dialog-footer-D_t7V-bM.js";import{b as de}from"./billing-queries-F2MY7m0o.js";import{F as w}from"./date-picker-DHqKAJpp.js";import{F as v}from"./select-Bv69-mBO.js";import{F as me}from"./formatted-price-BZx2tBTa.js";import{f as ue,a as b,F as D}from"./select-filter-panel-2MY77qxo.js";import{t as pe,c as xe,u as be}from"./timestamp-filters-C0zLPmIY.js";import"./FilterAlt-xRRmNiqG.js";import"./accordion-CpK0I08P.js";import"./checkbox-CiHJ6TYf.js";import"./CheckBoxOutlineBlank-6JQ3-TmB.js";import"./KeyboardArrowRight-ChYgp5kQ.js";import"./skeleton-xT-yudp1.js";import"./dashboard-layout-context-Cg5RoSzJ.js";import"./use-toggle-dashboard-left-sidebar-B95u609v.js";import"./ArrowDownward-BrhAHC5n.js";import"./useEffectEvent-BzNFWHXk.js";import"./use-pointer-events-BS6HVgE8.js";import"./useGlobalListeners-MjeT7y1B.js";import"./use-date-formatter-BiXQj-wq.js";import"./Add-BV-9IpU7.js";import"./use-current-date-time-lVcX-4fw.js";import"./DateRange-6Lw_fZZT.js";import"./use-base-date-picker-state-Cn_aBnWX.js";import"./input-4Oo6Fyef.js";import"./use-normalized-models-Cb3k3qGb.js";import"./form-chip-field-CYaGs1JT.js";import"./ArrowRightAlt-PxVB8wV6.js";import"./use-date-range-picker-state-Bb0A2vO_.js";import"./list-B5Ky1WKX.js";import"./switch-DbAW1G8x.js";import"./formatted-number-1UpMPscB.js";const ge="billing/subscriptions";function je(s){const{trans:t}=_();return F({mutationFn:i=>he(i),onSuccess:()=>{k(t(n("Subscription created"))),u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})},onError:i=>P(i,s)})}function he(s){return N.post(ge,s).then(t=>t.data)}function R({form:s,onSubmit:t,formId:i}){var x,d;const r=K(de.products.index()),c=s.watch("product_id"),o=(x=r.data)==null?void 0:x.products.find(l=>l.id===c);return e.jsxs(z,{id:i,form:s,onSubmit:t,children:[e.jsx(ue,{name:"user_id",className:"mb-20",endpoint:"normalized-models/user",label:e.jsx(a,{message:"User"})}),e.jsx(v,{name:"product_id",selectionMode:"single",className:"mb-20",label:e.jsx(a,{message:"Plan"}),children:(d=r.data)==null?void 0:d.products.filter(l=>!l.free).map(l=>e.jsx(S,{value:l.id,children:e.jsx(a,{message:l.name})},l.id))}),!(o!=null&&o.free)&&e.jsx(v,{name:"price_id",selectionMode:"single",className:"mb-20",label:e.jsx(a,{message:"Price"}),children:o==null?void 0:o.prices.map(l=>e.jsx(S,{value:l.id,children:e.jsx(me,{price:l})},l.id))}),e.jsx(M,{inputElementType:"textarea",rows:3,name:"description",label:e.jsx(a,{message:"Description"}),className:"mb-20"}),e.jsx(w,{className:"mb-20",name:"renews_at",granularity:"day",label:e.jsx(a,{message:"Renews at"}),description:e.jsx(a,{message:"This will only change local records. User will continue to be billed on their original cycle on the payment gateway."})}),e.jsx(w,{className:"mb-20",name:"ends_at",granularity:"day",label:e.jsx(a,{message:"Ends at"}),description:e.jsx(a,{message:"This will only change local records. User will continue to be billed on their original cycle on the payment gateway."})})]})}function ye(){const{close:s,formId:t}=T(),i=I({}),r=je(i);return e.jsxs(A,{children:[e.jsx(E,{children:e.jsx(a,{message:"Add new subscription"})}),e.jsx(q,{children:e.jsx(R,{formId:t,form:i,onSubmit:c=>{r.mutate(c,{onSuccess:()=>{s()}})}})}),e.jsxs(Q,{children:[e.jsx(g,{onClick:()=>{s()},children:e.jsx(a,{message:"Cancel"})}),e.jsx(g,{form:t,disabled:r.isPending,variant:"flat",color:"primary",type:"submit",children:e.jsx(a,{message:"Save"})})]})]})}const C=[{key:"ends_at",label:n("Status"),description:n("Whether subscription is active or cancelled"),defaultOperator:b.eq,control:{type:D.Select,defaultValue:"active",options:[{key:"active",label:n("Active"),value:{value:null,operator:b.eq}},{key:"cancelled",label:n("Cancelled"),value:{value:null,operator:b.ne}}]}},{control:{type:D.Select,defaultValue:"stripe",options:[{key:"stripe",label:n("Stripe"),value:"stripe"},{key:"paypal",label:n("PayPal"),value:"paypal"},{key:"none",label:n("None"),value:"none"}]},key:"gateway_name",label:n("Gateway"),description:n("With which payment provider was subscription created"),defaultOperator:b.eq},pe({key:"renews_at",label:n("Renew date"),description:n("Date subscription will renew")}),xe({description:n("Date subscription was created")}),be({description:n("Date subscription was last updated")})],fe=""+new URL("subscriptions-84PnlvDT.svg",import.meta.url).href;function Se(s){const{trans:t}=_();return F({mutationFn:i=>we(i),onSuccess:()=>{k(t(n("Subscription updated"))),u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})},onError:i=>P(i,s)})}function we({id:s,...t}){return N.put(`billing/subscriptions/${s}`,t).then(i=>i.data)}function ve({subscription:s}){const{close:t,formId:i}=T(),r=I({defaultValues:{id:s.id,product_id:s.product_id,price_id:s.price_id,description:s.description,renews_at:s.renews_at,ends_at:s.ends_at,user_id:s.user_id}}),c=Se(r);return e.jsxs(A,{size:"md",children:[e.jsx(E,{children:e.jsx(a,{message:"Update subscription"})}),e.jsx(q,{children:e.jsx(R,{formId:i,form:r,onSubmit:o=>{c.mutate(o,{onSuccess:()=>{t()}})}})}),e.jsxs(Q,{children:[e.jsx(g,{onClick:()=>{t()},children:e.jsx(a,{message:"Cancel"})}),e.jsx(g,{form:i,disabled:c.isPending,variant:"flat",color:"primary",type:"submit",children:e.jsx(a,{message:"Save"})})]})]})}const De=[{key:"user_id",allowsSorting:!0,width:"flex-3 min-w-200",visibleInMode:"all",header:()=>e.jsx(a,{message:"Customer"}),body:s=>s.user&&e.jsx(le,{image:s.user.image,label:s.user.name,description:s.user.email})},{key:"status",width:"w-100 flex-shrink-0",header:()=>e.jsx(a,{message:"Status"}),body:s=>e.jsx(U,{size:"xs",color:s.valid?"positive":"danger",radius:"rounded",className:"w-max",children:s.gateway_status})},{key:"product_id",allowsSorting:!0,header:()=>e.jsx(a,{message:"Plan"}),body:s=>{var t;return(t=s.product)==null?void 0:t.name}},{key:"gateway_name",allowsSorting:!0,header:()=>e.jsx(a,{message:"Gateway"}),body:s=>e.jsx("span",{className:"capitalize",children:s.gateway_name})},{key:"renews_at",allowsSorting:!0,header:()=>e.jsx(a,{message:"Renews at"}),body:s=>e.jsx(h,{date:s.renews_at})},{key:"ends_at",allowsSorting:!0,header:()=>e.jsx(a,{message:"Ends at"}),body:s=>e.jsx(h,{date:s.ends_at})},{key:"created_at",allowsSorting:!0,header:()=>e.jsx(a,{message:"Created at"}),body:s=>e.jsx(h,{date:s.created_at})},{key:"actions",header:()=>e.jsx(a,{message:"Actions"}),hideHeader:!0,align:"end",visibleInMode:"all",width:"w-[168px] flex-shrink-0",body:s=>e.jsx(Ce,{subscription:s})}];function fs(){const{searchParams:s,sortDescriptor:t,mergeIntoSearchParams:i,setSearchQuery:r,isFiltering:c}=V(H),o=L(m.subscriptions.index(s)),x=e.jsxs(p,{type:"modal",children:[e.jsx(ce,{children:e.jsx(a,{message:"Add new subscription"})}),e.jsx(ye,{})]});return e.jsxs(Z,{children:[e.jsx(O,{query:o}),e.jsx(ee,{title:e.jsx(a,{message:"Subscriptions"}),showSidebarToggleButton:!0}),e.jsxs(se,{children:[e.jsx(J,{searchValue:s.query,onSearchChange:r,actions:x,filters:C}),e.jsx(Y,{filters:C}),e.jsxs(ae,{children:[e.jsx(te,{columns:De,data:o.items,sortDescriptor:t,onSortChange:i,enableSelection:!1}),o.isEmpty&&e.jsx($,{className:"mt-50",isFiltering:c,image:fe,title:e.jsx(a,{message:"No subscriptions have been created yet"}),filteringTitle:e.jsx(a,{message:"No matching subscriptions"})}),e.jsx(X,{query:o,onPageChange:d=>i({page:d}),onPerPageChange:d=>i({perPage:d})})]})]})]})}function Ce({subscription:s}){return e.jsxs(W.Fragment,{children:[e.jsxs(p,{type:"modal",children:[e.jsx(j,{size:"md",className:"text-muted",children:e.jsx(ie,{})}),e.jsx(ve,{subscription:s})]}),s.cancelled&&s.on_grace_period?e.jsx(Fe,{subscription:s}):null,s.active?e.jsx(_e,{subscription:s}):null,e.jsx(Pe,{subscription:s})]})}function _e({subscription:s}){const t=B(),i=()=>{t.mutate({subscriptionId:s.id},{onSuccess:()=>{u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})}})};return e.jsxs(p,{type:"modal",onClose:r=>{r&&i()},children:[e.jsx(y,{label:e.jsx(a,{message:"Cancel subscription"}),children:e.jsx(j,{size:"md",className:"text-muted",disabled:t.isPending,children:e.jsx(ne,{})})}),e.jsx(f,{title:e.jsx(a,{message:"Cancel subscription"}),body:e.jsxs("div",{children:[e.jsx(a,{message:"Are you sure you want to cancel this subscription?"}),e.jsx("div",{className:"mt-10 text-sm font-semibold",children:e.jsx(a,{message:"This will put user on grace period until their next scheduled renewal date. Subscription can be renewed until that date by user or from admin area."})})]}),confirm:e.jsx(a,{message:"Confirm"})})]})}function Fe({subscription:s}){const t=oe(),i=()=>{t.mutate({subscriptionId:s.id},{onSuccess:()=>{u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})}})};return e.jsxs(p,{type:"modal",onClose:r=>{r&&i()},children:[e.jsx(y,{label:e.jsx(a,{message:"Renew subscription"}),children:e.jsx(j,{size:"md",className:"text-muted",onClick:i,disabled:t.isPending,children:e.jsx(re,{})})}),e.jsx(f,{title:e.jsx(a,{message:"Resume subscription"}),body:e.jsxs("div",{children:[e.jsx(a,{message:"Are you sure you want to resume this subscription?"}),e.jsx("div",{className:"mt-10 text-sm font-semibold",children:e.jsx(a,{message:"This will put user on their original plan and billing cycle."})})]}),confirm:e.jsx(a,{message:"Confirm"})})]})}function Pe({subscription:s}){const t=B(),i=()=>{t.mutate({subscriptionId:s.id,delete:!0},{onSuccess:()=>{u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})}})};return e.jsxs(p,{type:"modal",onClose:r=>{r&&i()},children:[e.jsx(y,{label:e.jsx(a,{message:"Delete subscription"}),children:e.jsx(j,{size:"md",className:"text-muted",disabled:t.isPending,children:e.jsx(G,{})})}),e.jsx(f,{isDanger:!0,title:e.jsx(a,{message:"Delete subscription"}),body:e.jsxs("div",{children:[e.jsx(a,{message:"Are you sure you want to delete this subscription?"}),e.jsx("div",{className:"mt-10 text-sm font-semibold",children:e.jsx(a,{message:"This will permanently delete the subscription and immediately cancel it on billing gateway. Subscription will not be renewable anymore."})})]}),confirm:e.jsx(a,{message:"Confirm"})})]})}export{fs as Component};
//# sourceMappingURL=subscriptions-index-page-B7yOP-xZ.js.map
