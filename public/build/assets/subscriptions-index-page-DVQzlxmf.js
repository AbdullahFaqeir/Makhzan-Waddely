import{w as _,ap as F,ar as P,aJ as k,x as n,ax as u,ce as m,k as N,e as K,j as e,ao as z,T as a,a6 as S,a4 as M,a8 as T,a3 as I,M as A,Q as q,R as E,B as g,cH as H,D as p,aA as U,r as W,J as j,aD as y,am as G}from"./main-BdzhGpqn.js";import{u as V,a as L,G as O,D as J,b as $,c as X}from"./use-datatable-query-CL53W5gM.js";import{D as Y}from"./datatable-filters-Cd3MyVOw.js";import{a as Z,D as ee,b as se,c as ae}from"./datatable-page-with-header-layout-T5QYry_g.js";import{T as te}from"./table-BV_6nbvK.js";import{F as h}from"./formatted-date-hsbUwQxj.js";import{E as ie}from"./Edit-AfuLMjS-.js";import{P as re,a as ne}from"./PlayArrow-B9cXsT4D.js";import{C as f}from"./confirmation-dialog-DtIJ4lxn.js";import{u as Q}from"./use-cancel-subscription-Db-m0VVe.js";import{u as oe}from"./use-resume-subscription-BTWdNKAW.js";import{N as le}from"./name-with-avatar-oLONXEoV.js";import{D as ce}from"./data-table-add-item-button-DnF2ZiVm.js";import{D as B}from"./dialog-footer-DL2JkwrZ.js";import{b as de}from"./billing-queries-7PHfszbY.js";import{F as w}from"./date-picker-BiDllGjz.js";import{F as v}from"./select-l28gQBMg.js";import{F as me}from"./formatted-price-DRpdBayZ.js";import{f as ue,a as b,F as D}from"./select-filter-panel-BD_PypVS.js";import{t as pe,c as xe,u as be}from"./timestamp-filters-Bn_q9MOg.js";import"./FilterAlt-BkhHIgY7.js";import"./accordion-DxYXjiZR.js";import"./checkbox-B6q4SJqi.js";import"./CheckBoxOutlineBlank-DvnJQjlB.js";import"./KeyboardArrowRight-DFizyHtY.js";import"./skeleton-CTimao-U.js";import"./dashboard-layout-context-DDiFtkN0.js";import"./use-toggle-dashboard-left-sidebar-Dzdho4R0.js";import"./ArrowDownward-DXr7353z.js";import"./useEffectEvent-D8HiMrwe.js";import"./use-pointer-events-Dsln3OKq.js";import"./useGlobalListeners-C14jVC5X.js";import"./use-date-formatter-BlrPWK68.js";import"./Add-iOynMxF0.js";import"./use-current-date-time-CnLDai64.js";import"./DateRange-DT2RCJ3g.js";import"./use-base-date-picker-state-DYteqbZD.js";import"./input-CDTJ1VfY.js";import"./use-normalized-models-yOhv1j4Y.js";import"./form-chip-field-Bj0OQHU9.js";import"./ArrowRightAlt-DSM1kJ5L.js";import"./use-date-range-picker-state-CEbm743A.js";import"./list-DRfBegha.js";import"./switch-DFT-JawA.js";import"./formatted-number-pJC-IR-x.js";const ge="billing/subscriptions";function je(s){const{trans:t}=_();return F({mutationFn:i=>he(i),onSuccess:()=>{k(t(n("Subscription created"))),u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})},onError:i=>P(i,s)})}function he(s){return N.post(ge,s).then(t=>t.data)}function R({form:s,onSubmit:t,formId:i}){var x,d;const r=K(de.products.index()),c=s.watch("product_id"),o=(x=r.data)==null?void 0:x.products.find(l=>l.id===c);return e.jsxs(z,{id:i,form:s,onSubmit:t,children:[e.jsx(ue,{name:"user_id",className:"mb-20",endpoint:"normalized-models/user",label:e.jsx(a,{message:"User"})}),e.jsx(v,{name:"product_id",selectionMode:"single",className:"mb-20",label:e.jsx(a,{message:"Plan"}),children:(d=r.data)==null?void 0:d.products.filter(l=>!l.free).map(l=>e.jsx(S,{value:l.id,children:e.jsx(a,{message:l.name})},l.id))}),!(o!=null&&o.free)&&e.jsx(v,{name:"price_id",selectionMode:"single",className:"mb-20",label:e.jsx(a,{message:"Price"}),children:o==null?void 0:o.prices.map(l=>e.jsx(S,{value:l.id,children:e.jsx(me,{price:l})},l.id))}),e.jsx(M,{inputElementType:"textarea",rows:3,name:"description",label:e.jsx(a,{message:"Description"}),className:"mb-20"}),e.jsx(w,{className:"mb-20",name:"renews_at",granularity:"day",label:e.jsx(a,{message:"Renews at"}),description:e.jsx(a,{message:"This will only change local records. User will continue to be billed on their original cycle on the payment gateway."})}),e.jsx(w,{className:"mb-20",name:"ends_at",granularity:"day",label:e.jsx(a,{message:"Ends at"}),description:e.jsx(a,{message:"This will only change local records. User will continue to be billed on their original cycle on the payment gateway."})})]})}function ye(){const{close:s,formId:t}=T(),i=I({}),r=je(i);return e.jsxs(A,{children:[e.jsx(q,{children:e.jsx(a,{message:"Add new subscription"})}),e.jsx(E,{children:e.jsx(R,{formId:t,form:i,onSubmit:c=>{r.mutate(c,{onSuccess:()=>{s()}})}})}),e.jsxs(B,{children:[e.jsx(g,{onClick:()=>{s()},children:e.jsx(a,{message:"Cancel"})}),e.jsx(g,{form:t,disabled:r.isPending,variant:"flat",color:"primary",type:"submit",children:e.jsx(a,{message:"Save"})})]})]})}const C=[{key:"ends_at",label:n("Status"),description:n("Whether subscription is active or cancelled"),defaultOperator:b.eq,control:{type:D.Select,defaultValue:"active",options:[{key:"active",label:n("Active"),value:{value:null,operator:b.eq}},{key:"cancelled",label:n("Cancelled"),value:{value:null,operator:b.ne}}]}},{control:{type:D.Select,defaultValue:"stripe",options:[{key:"stripe",label:n("Stripe"),value:"stripe"},{key:"paypal",label:n("PayPal"),value:"paypal"},{key:"none",label:n("None"),value:"none"}]},key:"gateway_name",label:n("Gateway"),description:n("With which payment provider was subscription created"),defaultOperator:b.eq},pe({key:"renews_at",label:n("Renew date"),description:n("Date subscription will renew")}),xe({description:n("Date subscription was created")}),be({description:n("Date subscription was last updated")})],fe=""+new URL("subscriptions-84PnlvDT.svg",import.meta.url).href;function Se(s){const{trans:t}=_();return F({mutationFn:i=>we(i),onSuccess:()=>{k(t(n("Subscription updated"))),u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})},onError:i=>P(i,s)})}function we({id:s,...t}){return N.put(`billing/subscriptions/${s}`,t).then(i=>i.data)}function ve({subscription:s}){const{close:t,formId:i}=T(),r=I({defaultValues:{id:s.id,product_id:s.product_id,price_id:s.price_id,description:s.description,renews_at:s.renews_at,ends_at:s.ends_at,user_id:s.user_id}}),c=Se(r);return e.jsxs(A,{size:"md",children:[e.jsx(q,{children:e.jsx(a,{message:"Update subscription"})}),e.jsx(E,{children:e.jsx(R,{formId:i,form:r,onSubmit:o=>{c.mutate(o,{onSuccess:()=>{t()}})}})}),e.jsxs(B,{children:[e.jsx(g,{onClick:()=>{t()},children:e.jsx(a,{message:"Cancel"})}),e.jsx(g,{form:i,disabled:c.isPending,variant:"flat",color:"primary",type:"submit",children:e.jsx(a,{message:"Save"})})]})]})}const De=[{key:"user_id",allowsSorting:!0,width:"flex-3 min-w-200",visibleInMode:"all",header:()=>e.jsx(a,{message:"Customer"}),body:s=>s.user&&e.jsx(le,{image:s.user.image,label:s.user.name,description:s.user.email})},{key:"status",width:"w-100 flex-shrink-0",header:()=>e.jsx(a,{message:"Status"}),body:s=>e.jsx(U,{size:"xs",color:s.valid?"positive":"danger",radius:"rounded",className:"w-max",children:s.gateway_status})},{key:"product_id",allowsSorting:!0,header:()=>e.jsx(a,{message:"Plan"}),body:s=>{var t;return(t=s.product)==null?void 0:t.name}},{key:"gateway_name",allowsSorting:!0,header:()=>e.jsx(a,{message:"Gateway"}),body:s=>e.jsx("span",{className:"capitalize",children:s.gateway_name})},{key:"renews_at",allowsSorting:!0,header:()=>e.jsx(a,{message:"Renews at"}),body:s=>e.jsx(h,{date:s.renews_at})},{key:"ends_at",allowsSorting:!0,header:()=>e.jsx(a,{message:"Ends at"}),body:s=>e.jsx(h,{date:s.ends_at})},{key:"created_at",allowsSorting:!0,header:()=>e.jsx(a,{message:"Created at"}),body:s=>e.jsx(h,{date:s.created_at})},{key:"actions",header:()=>e.jsx(a,{message:"Actions"}),hideHeader:!0,align:"end",visibleInMode:"all",width:"w-[168px] flex-shrink-0",body:s=>e.jsx(Ce,{subscription:s})}];function fs(){const{searchParams:s,sortDescriptor:t,mergeIntoSearchParams:i,setSearchQuery:r,isFiltering:c}=V(H),o=L(m.subscriptions.index(s)),x=e.jsxs(p,{type:"modal",children:[e.jsx(ce,{children:e.jsx(a,{message:"Add new subscription"})}),e.jsx(ye,{})]});return e.jsxs(Z,{children:[e.jsx(O,{query:o}),e.jsx(ee,{title:e.jsx(a,{message:"Subscriptions"}),showSidebarToggleButton:!0}),e.jsxs(se,{children:[e.jsx(J,{searchValue:s.query,onSearchChange:r,actions:x,filters:C}),e.jsx(Y,{filters:C}),e.jsxs(ae,{children:[e.jsx(te,{columns:De,data:o.items,sortDescriptor:t,onSortChange:i,enableSelection:!1}),o.isEmpty&&e.jsx($,{className:"mt-50",isFiltering:c,image:fe,title:e.jsx(a,{message:"No subscriptions have been created yet"}),filteringTitle:e.jsx(a,{message:"No matching subscriptions"})}),e.jsx(X,{query:o,onPageChange:d=>i({page:d}),onPerPageChange:d=>i({perPage:d})})]})]})]})}function Ce({subscription:s}){return e.jsxs(W.Fragment,{children:[e.jsxs(p,{type:"modal",children:[e.jsx(j,{size:"md",className:"text-muted",children:e.jsx(ie,{})}),e.jsx(ve,{subscription:s})]}),s.cancelled&&s.on_grace_period?e.jsx(Fe,{subscription:s}):null,s.active?e.jsx(_e,{subscription:s}):null,e.jsx(Pe,{subscription:s})]})}function _e({subscription:s}){const t=Q(),i=()=>{t.mutate({subscriptionId:s.id},{onSuccess:()=>{u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})}})};return e.jsxs(p,{type:"modal",onClose:r=>{r&&i()},children:[e.jsx(y,{label:e.jsx(a,{message:"Cancel subscription"}),children:e.jsx(j,{size:"md",className:"text-muted",disabled:t.isPending,children:e.jsx(ne,{})})}),e.jsx(f,{title:e.jsx(a,{message:"Cancel subscription"}),body:e.jsxs("div",{children:[e.jsx(a,{message:"Are you sure you want to cancel this subscription?"}),e.jsx("div",{className:"mt-10 text-sm font-semibold",children:e.jsx(a,{message:"This will put user on grace period until their next scheduled renewal date. Subscription can be renewed until that date by user or from admin area."})})]}),confirm:e.jsx(a,{message:"Confirm"})})]})}function Fe({subscription:s}){const t=oe(),i=()=>{t.mutate({subscriptionId:s.id},{onSuccess:()=>{u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})}})};return e.jsxs(p,{type:"modal",onClose:r=>{r&&i()},children:[e.jsx(y,{label:e.jsx(a,{message:"Renew subscription"}),children:e.jsx(j,{size:"md",className:"text-muted",onClick:i,disabled:t.isPending,children:e.jsx(re,{})})}),e.jsx(f,{title:e.jsx(a,{message:"Resume subscription"}),body:e.jsxs("div",{children:[e.jsx(a,{message:"Are you sure you want to resume this subscription?"}),e.jsx("div",{className:"mt-10 text-sm font-semibold",children:e.jsx(a,{message:"This will put user on their original plan and billing cycle."})})]}),confirm:e.jsx(a,{message:"Confirm"})})]})}function Pe({subscription:s}){const t=Q(),i=()=>{t.mutate({subscriptionId:s.id,delete:!0},{onSuccess:()=>{u.invalidateQueries({queryKey:m.subscriptions.invalidateKey})}})};return e.jsxs(p,{type:"modal",onClose:r=>{r&&i()},children:[e.jsx(y,{label:e.jsx(a,{message:"Delete subscription"}),children:e.jsx(j,{size:"md",className:"text-muted",disabled:t.isPending,children:e.jsx(G,{})})}),e.jsx(f,{isDanger:!0,title:e.jsx(a,{message:"Delete subscription"}),body:e.jsxs("div",{children:[e.jsx(a,{message:"Are you sure you want to delete this subscription?"}),e.jsx("div",{className:"mt-10 text-sm font-semibold",children:e.jsx(a,{message:"This will permanently delete the subscription and immediately cancel it on billing gateway. Subscription will not be renewable anymore."})})]}),confirm:e.jsx(a,{message:"Confirm"})})]})}export{fs as Component};
