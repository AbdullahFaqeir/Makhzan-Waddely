{"version":3,"file":"stripe-elements-form-C9SM6Owt.js","sources":["../../../common/foundation/resources/client/billing/checkout/stripe/use-stripe.ts","../../../common/foundation/resources/client/billing/checkout/stripe/stripe-elements-form.tsx"],"sourcesContent":["import {useAuth} from '@common/auth/use-auth';\nimport {apiClient} from '@common/http/query-client';\nimport {loadStripe, Stripe, StripeElements} from '@stripe/stripe-js';\nimport {useSelectedLocale} from '@ui/i18n/selected-locale';\nimport {useSettings} from '@ui/settings/use-settings';\nimport {useIsDarkMode} from '@ui/themes/use-is-dark-mode';\nimport {useEffect, useRef, useState} from 'react';\n\ninterface UseStripeProps {\n  type: 'setupIntent' | 'subscription';\n  productId?: string | number;\n  priceId?: string | number;\n}\nexport function useStripe({type, productId, priceId}: UseStripeProps) {\n  const {user} = useAuth();\n  const isDarkMode = useIsDarkMode();\n  const isInitiatedRef = useRef<boolean>(false);\n  const paymentElementRef = useRef<HTMLDivElement>(null);\n  const {localeCode} = useSelectedLocale();\n  const [stripe, setStripe] = useState<Stripe | null>(null);\n  const [elements, setElements] = useState<StripeElements | null>(null);\n  const {\n    branding: {site_name},\n    billing: {\n      stripe_public_key,\n      stripe: {enable},\n    },\n  } = useSettings();\n\n  useEffect(() => {\n    if (!enable || !stripe_public_key || isInitiatedRef.current) return;\n\n    Promise.all([\n      // load stripe js library\n      loadStripe(stripe_public_key, {\n        //apiVersion: '2022-08-01',\n        locale: localeCode as any,\n      }),\n      // create partial subscription for clientSecret\n      type === 'setupIntent'\n        ? createSetupIntent()\n        : createSubscription(productId!, priceId),\n    ]).then(([stripe, {clientSecret}]) => {\n      if (stripe && paymentElementRef.current) {\n        const elements = stripe.elements({\n          clientSecret,\n          appearance: {\n            theme: isDarkMode ? 'night' : 'stripe',\n          },\n        });\n\n        // Create and mount the Payment Element\n        const paymentElement = elements.create('payment', {\n          business: {name: site_name},\n          terms: {card: 'never'},\n          fields: {\n            billingDetails: {\n              address: 'auto',\n            },\n          },\n          defaultValues: {\n            billingDetails: {\n              email: user?.email,\n            },\n          },\n        });\n        paymentElement.mount(paymentElementRef.current);\n\n        setStripe(stripe);\n        setElements(elements);\n      }\n    });\n\n    isInitiatedRef.current = true;\n  }, [\n    productId,\n    stripe_public_key,\n    enable,\n    isDarkMode,\n    localeCode,\n    site_name,\n    type,\n    user?.email,\n  ]);\n\n  return {\n    stripe,\n    elements,\n    paymentElementRef,\n    stripeIsEnabled: stripe_public_key != null && enable,\n  };\n}\n\nfunction createSetupIntent(): Promise<{clientSecret: string}> {\n  return apiClient.post('billing/stripe/create-setup-intent').then(r => r.data);\n}\n\nfunction createSubscription(\n  productId: number | string,\n  priceId?: number | string,\n): Promise<{clientSecret: string}> {\n  return apiClient\n    .post('billing/stripe/create-partial-subscription', {\n      product_id: productId,\n      price_id: priceId,\n    })\n    .then(r => r.data);\n}\n","import clsx from 'clsx';\nimport {Button} from '@ui/buttons/button';\nimport {FormEventHandler, Fragment, ReactNode, useState} from 'react';\nimport {useStripe} from '@common/billing/checkout/stripe/use-stripe';\nimport {Skeleton} from '@ui/skeleton/skeleton';\n\ninterface StripeElementsFormProps {\n  productId?: string | number;\n  priceId?: string | number;\n  type: 'setupIntent' | 'subscription';\n  submitLabel: ReactNode;\n  returnUrl: string;\n}\nexport function StripeElementsForm({\n  productId,\n  priceId,\n  type = 'subscription',\n  submitLabel,\n  returnUrl,\n}: StripeElementsFormProps) {\n  const {stripe, elements, paymentElementRef, stripeIsEnabled} = useStripe({\n    type,\n    productId,\n    priceId,\n  });\n  const [errorMessage, setErrorMessage] = useState<string | null>(null);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n\n  // disable upgrade button if stripe is enabled, but not loaded yet\n  const stripeIsReady: boolean =\n    !stripeIsEnabled || (elements != null && stripe != null);\n\n  const handleSubmit: FormEventHandler = async e => {\n    e.preventDefault();\n\n    // stripe has not loaded yet\n    if (!stripe || !elements) return;\n\n    setIsSubmitting(true);\n\n    try {\n      const method =\n        type === 'subscription' ? 'confirmPayment' : 'confirmSetup';\n      const result = await stripe[method]({\n        elements,\n        confirmParams: {\n          return_url: returnUrl,\n        },\n      });\n\n      // don't show validation error as it will be shown already by stripe payment element\n      if (result.error?.type !== 'validation_error' && result.error?.message) {\n        setErrorMessage(result.error.message);\n      }\n    } catch {}\n\n    setIsSubmitting(false);\n  };\n\n  return (\n    <form onSubmit={handleSubmit}>\n      <div\n        ref={paymentElementRef}\n        className={clsx('min-h-[303px]', !stripeIsEnabled && 'hidden')}\n      >\n        {stripeIsEnabled && <StripeSkeleton />}\n      </div>\n      {errorMessage && !isSubmitting && (\n        <div className=\"mt-20 text-danger\">{errorMessage}</div>\n      )}\n      <Button\n        variant=\"flat\"\n        color=\"primary\"\n        size=\"md\"\n        className=\"mt-40 w-full\"\n        type=\"submit\"\n        disabled={isSubmitting || !stripeIsReady}\n      >\n        {submitLabel}\n      </Button>\n    </form>\n  );\n}\n\nfunction StripeSkeleton() {\n  return (\n    <Fragment>\n      <Skeleton className=\"mb-20 h-30\" />\n      <Skeleton className=\"mb-20 h-30\" />\n      <Skeleton className=\"mb-20 h-30\" />\n      <Skeleton className=\"h-30\" />\n    </Fragment>\n  );\n}\n"],"names":["useStripe","type","productId","priceId","user","useAuth","isDarkMode","useIsDarkMode","isInitiatedRef","useRef","paymentElementRef","localeCode","useSelectedLocale","stripe","setStripe","useState","elements","setElements","site_name","stripe_public_key","enable","useSettings","useEffect","loadStripe","createSetupIntent","createSubscription","clientSecret","apiClient","r","StripeElementsForm","submitLabel","returnUrl","stripeIsEnabled","errorMessage","setErrorMessage","isSubmitting","setIsSubmitting","stripeIsReady","handleSubmit","e","result","_a","_b","jsxs","jsx","clsx","StripeSkeleton","Button","Fragment","Skeleton"],"mappings":"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"}