{"version":3,"file":"ad-host-CmxwDBsN.js","sources":["../../../common/foundation/resources/client/admin/ads/ad-host.tsx"],"sourcesContent":["import {useAuth} from '../../auth/use-auth';\nimport {memo, useEffect, useId, useMemo, useRef} from 'react';\nimport lazyLoader from '@ui/utils/loaders/lazy-loader';\nimport clsx from 'clsx';\nimport {useSettings} from '@ui/settings/use-settings';\nimport dot from 'dot-object';\nimport {Settings} from '@ui/settings/settings';\nimport {getScrollParent} from '@react-aria/utils';\n\ninterface AdHostProps {\n  slot: keyof Omit<NonNullable<Settings['ads']>, 'disable'>;\n  className?: string;\n}\nexport function AdHost({slot, className}: AdHostProps) {\n  const settings = useSettings();\n  const {isSubscribed} = useAuth();\n  const adCode = useMemo(() => {\n    return dot.pick(`ads.${slot}`, settings);\n  }, [slot, settings]);\n\n  if (settings.ads?.disable || isSubscribed || !adCode) return null;\n\n  return <InvariantAd className={className} slot={slot} adCode={adCode} />;\n}\n\ninterface InvariantAdProps {\n  slot: string;\n  adCode: string;\n  className?: string;\n}\nconst InvariantAd = memo(\n  ({slot, adCode, className}: InvariantAdProps) => {\n    const ref = useRef<HTMLDivElement>(null);\n\n    const id = useId();\n\n    useEffect(() => {\n      if (ref.current) {\n        loadAdScripts(adCode, ref.current).then(() => {\n          executeAdJavascript(adCode, id);\n        });\n      }\n      return () => {\n        // @ts-ignore\n        delete window['google_ad_modifications'];\n      };\n    }, [adCode, id]);\n\n    // remove height modifications added by adsense\n    useEffect(() => {\n      if (ref.current) {\n        const scrollParent = getScrollParent(ref.current) as HTMLElement;\n        if (scrollParent) {\n          const observer = new MutationObserver(function () {\n            scrollParent.style.height = '';\n            scrollParent.style.minHeight = '';\n          });\n          observer.observe(scrollParent, {\n            attributes: true,\n            attributeFilter: ['style'],\n          });\n          return () => observer.disconnect();\n        }\n      }\n    }, []);\n\n    return (\n      <div\n        ref={ref}\n        id={id}\n        className={clsx(\n          'ad-host flex max-h-[600px] min-h-90 w-full max-w-full items-center justify-center overflow-hidden',\n          `${slot.replace(/\\./g, '-')}-host`,\n          className,\n        )}\n        dangerouslySetInnerHTML={{__html: getAdHtml(adCode)}}\n      ></div>\n    );\n  },\n  () => {\n    // never re-render\n    return false;\n  },\n);\n\nfunction getAdHtml(adCode: string) {\n  // strip out all script tags from ad code and leave only html\n  return adCode\n    ?.replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '')\n    .trim();\n}\n\n// Load any external scripts needed by ad.\nfunction loadAdScripts(adCode: string, parentEl: HTMLDivElement): Promise<any> {\n  const promises = [];\n\n  // load ad code script\n  const pattern = /<script.*?src=['\"](.*?)['\"]/g;\n  let match;\n\n  while ((match = pattern.exec(adCode))) {\n    if (match[1]) {\n      promises.push(lazyLoader.loadAsset(match[1], {type: 'js', parentEl}));\n    }\n  }\n\n  return Promise.all(promises);\n}\n\n// Execute ad code javascript and replace document.write if needed.\nfunction executeAdJavascript(adCode: string, id: string) {\n  // find any ad code javascript that needs to be executed\n  const pattern = /<script\\b[^>]*>([\\s\\S]*?)<\\/script>/g;\n  let content;\n\n  while ((content = pattern.exec(adCode))) {\n    if (content[1]) {\n      const r = `var d = document.createElement('div'); d.innerHTML = $1; document.getElementById('${id}').appendChild(d.firstChild);`;\n      const toEval = content[1].replace(/document.write\\((.+?)\\);/, r);\n      eval(toEval);\n    }\n  }\n}\n"],"names":["slot","className","settings","isSubscribed","adCode","useMemo","_a","jsx","memo","ref","useRef","id","useId","useEffect","scrollParent","getScrollParent","observer","parentEl","promises","pattern","match"],"mappings":"qOAaO,SAAS,OAAO,CAAC,KAAAA,EAAM,UAAAC,GAAyB,OACrD,MAAMC,EAAW,YAAA,EACX,CAAC,aAAAC,CAAA,EAAgB,QAAA,EACjBC,EAASC,aAAAA,QAAQ,IACd,IAAI,KAAK,OAAOL,CAAI,GAAIE,CAAQ,EACtC,CAACF,EAAME,CAAQ,CAAC,EAEnB,OAAII,EAAAJ,EAAS,MAAT,MAAAI,EAAc,SAAWH,GAAgB,CAACC,EAAe,KAEtDG,kBAAAA,IAAC,YAAA,CAAY,UAAAN,EAAsB,KAAAD,EAAY,OAAQI,EAAQ,CACxE,CAOA,MAAM,YAAcI,aAAAA,KAClB,CAAC,CAAC,KAAAR,EAAM,OAAAI,EAAQ,UAAAH,KAAiC,CAC/C,MAAMQ,EAAMC,aAAAA,OAAuB,IAAI,EAEjCC,EAAKC,aAAAA,MAAA,EAEXC,oBAAAA,UAAU,KACJJ,EAAI,SACN,cAAcL,EAAQK,EAAI,OAAO,EAAE,KAAK,IAAM,CAC5C,oBAAoBL,EAAQO,CAAE,CAChC,CAAC,EAEI,IAAM,CAEX,OAAO,OAAO,uBAChB,GACC,CAACP,EAAQO,CAAE,CAAC,EAGfE,aAAAA,UAAU,IAAM,CACd,GAAIJ,EAAI,QAAS,CACf,MAAMK,EAAeC,0CAAgBN,EAAI,OAAO,EAChD,GAAIK,EAAc,CAChB,MAAME,EAAW,IAAI,iBAAiB,UAAY,CAChDF,EAAa,MAAM,OAAS,GAC5BA,EAAa,MAAM,UAAY,EACjC,CAAC,EACD,OAAAE,EAAS,QAAQF,EAAc,CAC7B,WAAY,GACZ,gBAAiB,CAAC,OAAO,CAAA,CAC1B,EACM,IAAME,EAAS,WAAA,CACxB,CACF,CACF,EAAG,CAAA,CAAE,EAGHT,kBAAAA,IAAC,MAAA,CACC,IAAAE,EACA,GAAIE,EACJ,UAAW,KACT,oGACA,GAAGX,EAAK,QAAQ,MAAO,GAAG,CAAC,QAC3BC,CAAA,EAEF,wBAAyB,CAAC,OAAQ,UAAUG,CAAM,CAAA,CAAC,CAAA,CAGzD,EACA,IAES,EAEX,EAEA,SAAS,UAAUA,EAAgB,CAEjC,OAAOA,GAAAA,YAAAA,EACH,QAAQ,sDAAuD,IAChE,MACL,CAGA,SAAS,cAAcA,EAAgBa,EAAwC,CAC7E,MAAMC,EAAW,CAAA,EAGXC,EAAU,+BAChB,IAAIC,EAEJ,KAAQA,EAAQD,EAAQ,KAAKf,CAAM,GAC7BgB,EAAM,CAAC,GACTF,EAAS,KAAK,WAAW,UAAUE,EAAM,CAAC,EAAG,CAAC,KAAM,KAAM,SAAAH,CAAA,CAAS,CAAC,EAIxE,OAAO,QAAQ,IAAIC,CAAQ,CAC7B,CAGA,SAAS,oBAAoB,OAAgB,GAAY,CAEvD,MAAM,QAAU,uCAChB,IAAI,QAEJ,KAAQ,QAAU,QAAQ,KAAK,MAAM,GACnC,GAAI,QAAQ,CAAC,EAAG,CACd,MAAM,EAAI,qFAAqF,EAAE,gCAC3F,OAAS,QAAQ,CAAC,EAAE,QAAQ,2BAA4B,CAAC,EAC/D,KAAK,MAAM,CACb,CAEJ"}