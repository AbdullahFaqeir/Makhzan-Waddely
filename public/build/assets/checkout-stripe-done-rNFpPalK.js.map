{"version":3,"file":"checkout-stripe-done-rNFpPalK.js","sources":["../../../common/foundation/resources/client/billing/checkout/stripe/checkout-stripe-done.tsx"],"sourcesContent":["import { apiClient } from '@common/http/query-client';\nimport { useNavigate } from '@common/ui/navigation/use-navigate';\nimport { loadStripe, PaymentIntent } from '@stripe/stripe-js';\nimport { message } from '@ui/i18n/message';\nimport { useSettings } from '@ui/settings/use-settings';\nimport { useEffect, useRef, useState } from 'react';\nimport { useParams, useSearchParams } from 'react-router';\nimport {\n  BillingRedirectMessage,\n  BillingRedirectMessageConfig,\n} from '../../billing-redirect-message';\nimport { CheckoutLayout } from '../checkout-layout';\nimport { CheckoutProductSummary } from '../checkout-product-summary';\n\nexport function Component() {\n  const {productId, priceId} = useParams();\n  const navigate = useNavigate();\n  const {\n    billing: {stripe_public_key},\n  } = useSettings();\n\n  const [params] = useSearchParams();\n  const clientSecret = params.get('payment_intent_client_secret');\n\n  const [messageConfig, setMessageConfig] =\n    useState<BillingRedirectMessageConfig>();\n\n  const stripeInitiated = useRef<boolean>(false);\n\n  useEffect(() => {\n    if (stripeInitiated.current) return;\n    loadStripe(stripe_public_key!).then(async stripe => {\n      if (!stripe || !clientSecret) {\n        setMessageConfig(getRedirectMessageConfig());\n        return;\n      }\n      stripe\n        .retrievePaymentIntent(clientSecret)\n        .then(async ({paymentIntent}) => {\n          if (paymentIntent?.status === 'succeeded') {\n            await storeSubscriptionDetailsLocally(paymentIntent.id);\n            setMessageConfig(\n              getRedirectMessageConfig('succeeded', productId, priceId),\n            );\n            window.location.href = '/billing';\n          } else {\n            setMessageConfig(\n              getRedirectMessageConfig(\n                paymentIntent?.status,\n                productId,\n                priceId,\n              ),\n            );\n          }\n        });\n    });\n    stripeInitiated.current = true;\n  }, [stripe_public_key, clientSecret, priceId, productId]);\n\n  if (!clientSecret) {\n    navigate('/');\n    return null;\n  }\n\n  return (\n    <CheckoutLayout>\n      <BillingRedirectMessage config={messageConfig} />\n      <CheckoutProductSummary showBillingLine={false} />\n    </CheckoutLayout>\n  );\n}\n\nfunction getRedirectMessageConfig(\n  status?: PaymentIntent.Status,\n  productId?: string,\n  priceId?: string,\n): BillingRedirectMessageConfig {\n  switch (status) {\n    case 'succeeded':\n      return {\n        message: message('Subscription successful!'),\n        status: 'success',\n        buttonLabel: message('Return to site'),\n        link: '/billing',\n      };\n    case 'processing':\n      return {\n        message: message(\n          \"Payment processing. We'll update you when payment is received.\",\n        ),\n        status: 'success',\n        buttonLabel: message('Return to site'),\n        link: '/billing',\n      };\n    case 'requires_payment_method':\n      return {\n        message: message('Payment failed. Please try another payment method.'),\n        status: 'error',\n        buttonLabel: message('Go back'),\n        link: errorLink(productId, priceId),\n      };\n    default:\n      return {\n        message: message('Something went wrong'),\n        status: 'error',\n        buttonLabel: message('Go back'),\n        link: errorLink(productId, priceId),\n      };\n  }\n}\n\nfunction errorLink(productId?: string, priceId?: string): string {\n  return productId && priceId ? `/checkout/${productId}/${priceId}` : '/';\n}\n\nfunction storeSubscriptionDetailsLocally(paymentIntentId: string) {\n  return apiClient.post('billing/stripe/store-subscription-details-locally', {\n    payment_intent_id: paymentIntentId,\n  });\n}\n"],"names":["Component","productId","priceId","useParams","navigate","useNavigate","stripe_public_key","useSettings","params","useSearchParams","clientSecret","messageConfig","setMessageConfig","useState","stripeInitiated","useRef","useEffect","loadStripe","stripe","getRedirectMessageConfig","paymentIntent","storeSubscriptionDetailsLocally","CheckoutLayout","jsx","BillingRedirectMessage","CheckoutProductSummary","status","message","errorLink","paymentIntentId","apiClient"],"mappings":"+aAcO,SAASA,GAAY,CAC1B,KAAM,CAAC,UAAAC,EAAW,QAAAC,CAAA,EAAWC,EAAA,EACvBC,EAAWC,EAAA,EACX,CACJ,QAAS,CAAC,kBAAAC,CAAA,CAAiB,EACzBC,EAAA,EAEE,CAACC,CAAM,EAAIC,EAAA,EACXC,EAAeF,EAAO,IAAI,8BAA8B,EAExD,CAACG,EAAeC,CAAgB,EACpCC,WAAA,EAEIC,EAAkBC,EAAAA,OAAgB,EAAK,EAgC7C,OA9BAC,EAAAA,UAAU,IAAM,CACVF,EAAgB,UACpBG,EAAWX,CAAkB,EAAE,KAAK,MAAMY,GAAU,CAClD,GAAI,CAACA,GAAU,CAACR,EAAc,CAC5BE,EAAiBO,GAA0B,EAC3C,MACF,CACAD,EACG,sBAAsBR,CAAY,EAClC,KAAK,MAAO,CAAC,cAAAU,KAAmB,EAC3BA,GAAA,YAAAA,EAAe,UAAW,aAC5B,MAAMC,EAAgCD,EAAc,EAAE,EACtDR,EACEO,EAAyB,YAAalB,EAAWC,CAAO,CAAA,EAE1D,OAAO,SAAS,KAAO,YAEvBU,EACEO,EACEC,GAAA,YAAAA,EAAe,OACfnB,EACAC,CAAA,CACF,CAGN,CAAC,CACL,CAAC,EACDY,EAAgB,QAAU,GAC5B,EAAG,CAACR,EAAmBI,EAAcR,EAASD,CAAS,CAAC,EAEnDS,SAMFY,EAAA,CACC,SAAA,CAAAC,EAAAA,IAACC,EAAA,CAAuB,OAAQb,CAAA,CAAe,EAC/CY,EAAAA,IAACE,EAAA,CAAuB,gBAAiB,EAAA,CAAO,CAAA,EAClD,GARArB,EAAS,GAAG,EACL,KASX,CAEA,SAASe,EACPO,EACAzB,EACAC,EAC8B,CAC9B,OAAQwB,EAAA,CACN,IAAK,YACH,MAAO,CACL,QAASC,EAAQ,0BAA0B,EAC3C,OAAQ,UACR,YAAaA,EAAQ,gBAAgB,EACrC,KAAM,UAAA,EAEV,IAAK,aACH,MAAO,CACL,QAASA,EACP,gEAAA,EAEF,OAAQ,UACR,YAAaA,EAAQ,gBAAgB,EACrC,KAAM,UAAA,EAEV,IAAK,0BACH,MAAO,CACL,QAASA,EAAQ,oDAAoD,EACrE,OAAQ,QACR,YAAaA,EAAQ,SAAS,EAC9B,KAAMC,EAAU3B,EAAWC,CAAO,CAAA,EAEtC,QACE,MAAO,CACL,QAASyB,EAAQ,sBAAsB,EACvC,OAAQ,QACR,YAAaA,EAAQ,SAAS,EAC9B,KAAMC,EAAU3B,EAAWC,CAAO,CAAA,CACpC,CAEN,CAEA,SAAS0B,EAAU3B,EAAoBC,EAA0B,CAC/D,OAAOD,GAAaC,EAAU,aAAaD,CAAS,IAAIC,CAAO,GAAK,GACtE,CAEA,SAASmB,EAAgCQ,EAAyB,CAChE,OAAOC,EAAU,KAAK,oDAAqD,CACzE,kBAAmBD,CAAA,CACpB,CACH"}