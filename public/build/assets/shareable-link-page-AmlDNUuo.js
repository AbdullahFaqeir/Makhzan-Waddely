import{b7 as V,b8 as J,t as U,v as R,b5 as M,h as E,a1 as W,Y,b9 as X,k as N,j as e,G as L,ba as Z,b4 as ee,r as g,c as w,P as b,A as se,y as ae,z as re,D as te,ap as T,aq as B,x as y,ax as oe,aJ as ie,l as ne,ak as le,J as F,b0 as de,al as ce,a6 as k,T as p,aD as me,B as A,aG as ue,aH as _,N as pe,aw as he,w as q,ay as xe,bb as fe,bc as ge}from"./main-BdzhGpqn.js";import{a as ve,B as we,i as K,n as je,l as be,A as ye,D as Pe,C as Ie}from"./dashboard-content-header-By3paBPj.js";import{T as Ne}from"./table-BV_6nbvK.js";import{A as $}from"./ad-host-BsbSWmNF.js";import{a as Fe,u as Se,c as De,b as ke}from"./file-preview-dialog-C3JXygxI.js";import{F as Ce}from"./file-upload-provider-Cq9bpz4o.js";import{F as P}from"./FileDownload-CzvSUcXm.js";import{I as Me,G as Ee}from"./GridView-CobJCxg9.js";import{d as I}from"./download-file-from-url-BVaKcxRP.js";import{B as Le,a as Te}from"./breadcrumb-DXXuqeGE.js";import{D as Be,a as Ae}from"./dashboard-layout-DZ4Y7yas.js";import{s as _e}from"./secure-files-DjSbgaf8.js";import"./dashboard-layout-context-DDiFtkN0.js";import"./Sort-DwtelFLc.js";import"./formatted-date-hsbUwQxj.js";import"./use-date-formatter-BlrPWK68.js";import"./checkbox-B6q4SJqi.js";import"./CheckBoxOutlineBlank-DvnJQjlB.js";import"./Delete-Bd6wbCuT.js";import"./Link-JJQq45pr.js";import"./index-DT7-cvGh.js";import"./pretty-bytes-bO14ePu9.js";import"./uploaded-file-BYIHeonQ.js";import"./FileUpload-CPJ1F6GL.js";import"./open-upload-window-DBvxFCUj.js";import"./MoreVert-BJhX_Lfk.js";import"./skeleton-CTimao-U.js";import"./ArrowDownward-DXr7353z.js";import"./useEffectEvent-D8HiMrwe.js";import"./use-pointer-events-Dsln3OKq.js";import"./useGlobalListeners-C14jVC5X.js";import"./getScrollParent--OCc5gFh.js";import"./ChevronLeft-CFnMYWTj.js";import"./ChevronRight-C9FQjnQQ.js";import"./KeyboardArrowRight-DFizyHtY.js";import"./MoreHoriz-uyJcPOJk.js";import"./use-previous-BIOPjABW.js";const m=V()(J(s=>({password:null,viewMode:U("drive.viewMode")||"grid",activeSort:{orderBy:"updated_at",orderDir:"desc"},setPassword:a=>{s(r=>{r.password=a})},isPasswordProtected:!1,setIsPasswordProtected:a=>{s(r=>{r.isPasswordProtected=a})},setViewMode:a=>{s(r=>{r.viewMode=a,R("drive.viewMode",a)})},setActiveSort:a=>{s(r=>{r.activeSort=a})}})));function f(){return m.getState()}function x(){var d,l;const{hash:s}=M(),a=m(t=>t.activeSort),r=m(t=>t.isPasswordProtected),i=m(t=>t.password),o=C(s,a,i),n=ve({queryKey:o,queryFn:async({pageParam:t=1})=>{const c=await N.get(`shareable-link-page/${s}`,{params:{loader:"shareableLinkPage",page:t,password:i,...a}}).then(u=>u.data);return c.passwordInvalid&&f().setIsPasswordProtected(!0),c},initialData:()=>{var u;const t=(u=Y().loaders)==null?void 0:u.shareableLinkPage;if(!(t!=null&&t.link))return;if(X(o,C(t.link.hash,{orderBy:"updated_at",orderDir:"desc"},i)))return t.passwordInvalid&&f().setIsPasswordProtected(!0),{pageParams:[void 0,1],pages:[t]}},initialPageParam:1,getNextPageParam:t=>{if(!t.folderChildren)return;const c=t.folderChildren.current_page,u=t.folderChildren.last_page;if(!(c>=u))return c+1},enabled:!!s&&!r||i!=null,placeholderData:W});return{...n,link:(d=n.data)==null?void 0:d.pages[0].link,entries:(l=n.data)==null?void 0:l.pages.flatMap(t=>{var c;return(c=t.folderChildren)==null?void 0:c.data})}}const C=(s,a,r)=>[E.shareableLinks.invalidateKey,"page",s,`${a.orderBy}:${a.orderDir}`,r];function qe({entries:s,onEntrySelected:a}){return e.jsx("div",{className:"file-grid",children:s.map((r,i)=>e.jsx(we,{tabIndex:-1,className:"hover:shadow-md cursor-pointer bg",entry:r,onContextMenu:o=>{o.preventDefault()},onKeyDown:o=>{(o.key==="Enter"||o.key===" ")&&a(r,i)},onClick:()=>{a(r,i)}},r.id))})}const Ke=K.filter(s=>s.key!=="updated_at");function $e({entries:s,onEntrySelected:a}){const r=m(o=>o.activeSort),i=L();return e.jsx(Ne,{columns:i?Ke:K,data:s,sortDescriptor:r,onSortChange:o=>{f().setActiveSort(o)},onAction:(o,n)=>{a(o,n)},enableSelection:!1})}function Ge(s,a){var i;let r=s.hash;return a&&((i=s.entry)==null?void 0:i.hash)!==a&&(r=`${r}:${a}`),r}function G(){const{link:s}=x(),a=Z();return r=>{s&&a(`/drive/s/${Ge(s,r)}`)}}function He({className:s}){const{pathname:a}=ee(),r=G(),[i,o]=g.useState(),n=m(h=>h.viewMode),d=g.useRef(null),{link:l,entries:t,isFetchingNextPage:c,hasNextPage:u,fetchNextPage:S,isPlaceholderData:Q}=x();if(g.useEffect(()=>{o(void 0)},[a]),g.useEffect(()=>{const h=d.current;if(!h)return;const v=new IntersectionObserver(([z])=>{z.isIntersecting&&u&&S()});return v.observe(h),()=>{v.unobserve(h)}},[u,S]),!l||Q)return e.jsx("div",{className:w("flex justify-center",s),children:e.jsx(b,{isIndeterminate:!0})});const D=(h,v)=>{h.type==="folder"?r(h.hash):o(v)},j=t||[];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:w("file-grid-container flex-auto overflow-auto px-14 pb-14 md:px-24 md:pb-24",s),children:[e.jsx($,{slot:"file-preview",className:"mb-40"}),n==="grid"?e.jsx(qe,{entries:j,onEntrySelected:D}):e.jsx($e,{entries:j,onEntrySelected:D}),e.jsx("span",{ref:d,"aria-hidden":!0}),e.jsx(se,{children:c&&e.jsx(ae.div,{className:"mt-24 flex w-full justify-center",...re,children:e.jsx(b,{isIndeterminate:!0,"aria-label":"loading"})})})]}),e.jsx(te,{type:"modal",isOpen:i!=null,onClose:()=>o(void 0),children:e.jsx(Fe,{entries:j,defaultActiveIndex:i,allowDownload:l.allow_download})})]})}function Oe({linkId:s,password:a}){return N.post(`shareable-links/${s}/import`,{password:a}).then(r=>r.data)}function Qe(){const s=m(a=>a.password);return T({mutationFn:a=>Oe({...a,password:s}),onSuccess:async()=>{await oe.invalidateQueries({queryKey:E.shareableLinks.invalidateKey}),ie(y("Item imported into your drive"))},onError:a=>B(a,y("Could not create link"))})}function H(){var d;const{link:s}=x(),{user:a,isLoggedIn:r}=ne(),{downloadUrl:i}=Se(s==null?void 0:s.entry),o=Qe(),n=(d=s==null?void 0:s.entry)==null?void 0:d.users.find(l=>l.id===(a==null?void 0:a.id));return s!=null&&s.entry?e.jsxs("div",{children:[s.allow_download&&e.jsx(ze,{downloadUrl:i}),!n&&r&&s.allow_edit&&e.jsxs(le,{onItemSelected:l=>{l==="import"?o.mutate({linkId:s.id}):l==="download"&&i&&I(i)},children:[e.jsx(F,{className:"ml-6",disabled:o.isPending,children:e.jsx(de,{})}),e.jsxs(ce,{children:[e.jsx(k,{value:"download",startIcon:e.jsx(P,{}),children:e.jsx(p,{message:"Download"})}),e.jsx(k,{value:"import",startIcon:e.jsx(Me,{}),children:e.jsx(p,{message:"Save a copy to your own drive"})})]})]})]}):null}function ze({downloadUrl:s}){return e.jsxs(g.Fragment,{children:[e.jsx(me,{label:e.jsx(p,{message:"Download"}),children:e.jsx(F,{className:"md:hidden",onClick:()=>{s&&I(s)},children:e.jsx(P,{})})}),e.jsx(A,{className:"max-md:hidden",size:"sm",variant:"flat",color:"chip",startIcon:e.jsx(P,{}),onClick:()=>{s&&I(s)},children:e.jsx(p,{message:"Download"})})]})}function Ve({className:s,folder:a,link:r}){const i=G(),o=m(l=>l.password),n=je({hash:a==null?void 0:a.hash,params:{shareable_link:r.id,password:o}});let d;if(n.isLoading)d=null;else{const l=[];n.data&&n.data.path.forEach(t=>{l.push({folder:t,label:e.jsx(e.Fragment,{children:t.name})})}),d=e.jsx(Le,{size:"lg",isNavigation:!0,children:l.map(t=>e.jsx(Te,{onSelected:()=>{i(t.folder.hash)},children:t.label},t.folder.hash))})}return e.jsx("div",{className:w("h-36 flex-shrink-0",s),children:d})}function Je(){const s=m(o=>o.activeSort),{link:a,isFetching:r}=x(),i=a&&a.entry;return e.jsxs("div",{className:"flex flex-col justify-between gap-14 p-14 md:h-90 md:flex-row md:items-center md:p-24",children:[i&&e.jsx(Ve,{link:a,folder:a.entry,className:"flex-auto"}),i&&e.jsxs("div",{className:"flex items-center justify-between text-muted md:justify-start",children:[e.jsx(be,{isDisabled:r,descriptor:s,onChange:o=>{f().setActiveSort(o)}}),e.jsx("div",{className:"ml-10 md:border-l md:pl-10",children:e.jsx(F,{onClick:()=>{f().setViewMode(f().viewMode==="grid"?"list":"grid")},children:e.jsx(Ee,{})})})]})]})}function Ue(){const{entries:s,isFetched:a}=x(),r=a&&!(s!=null&&s.length);return e.jsxs(Be,{name:"folder-preview",children:[e.jsx(ye,{hideToggleButton:!0,rightChildren:e.jsx(H,{}),color:"bg"}),e.jsx(Pe,{children:e.jsx(Je,{})}),e.jsx(Ce,{children:e.jsx(Ae,{children:r?e.jsx(Re,{}):e.jsx(He,{})})})]})}function Re({className:s}){return e.jsx(ue,{className:w(s,"mt-80"),image:e.jsx(_,{src:Ie}),title:e.jsx(p,{message:"Folder is empty"}),description:e.jsx(p,{message:"No files have been uploaded to this folder yet"})})}function We(){return T({mutationFn:({password:s,linkHash:a})=>N.post(`shareable-link-page/${a}/check-password`,{password:s}).then(r=>r.data),onSuccess:(s,a)=>{s.matches&&f().setPassword(a.password)},onError:s=>B(s,y("Could not create link"))})}function O(){const{link:s}=x(),a=L();return e.jsx(pe,{size:"md",color:"bg",className:"flex-shrink-0",rightChildren:(s==null?void 0:s.entry)&&e.jsx(H,{}),menuPosition:"shareable-link-page",hideLogo:a,children:(s==null?void 0:s.entry)&&s.entry.type!=="folder"&&e.jsxs("div",{className:"fex-auto flex min-w-0 items-center gap-10",children:[e.jsx(he,{className:"flex-shrink-0",type:s.entry.type}),e.jsx("div",{className:"flex-auto overflow-hidden overflow-ellipsis whitespace-nowrap font-medium",children:s.entry.name})]})})}function Ye(){const{trans:s}=q(),{hash:a}=M(),r=s({message:"Password"}),[i,o]=g.useState(""),n=We(),d=a?a.split(":")[0]:null,l=n.data&&!n.data.matches;return e.jsxs("div",{className:"flex h-screen flex-col bg-alt",children:[e.jsx(O,{}),e.jsx("div",{className:"mx-auto my-80 px-10 md:px-20",children:e.jsxs("div",{className:"flex max-w-[560px] flex-col items-center gap-40 rounded border bg p-24 md:flex-row md:gap-14",children:[e.jsx("div",{className:"h-132 w-[165px]",children:e.jsx(_,{src:_e})}),e.jsxs("form",{onSubmit:t=>{t.preventDefault(),n.mutate({linkHash:d,password:i})},children:[e.jsx("span",{className:"text-sm",children:e.jsx(p,{message:"The link you are trying to access is password protected."})}),e.jsx(xe,{autoFocus:!0,placeholder:r,"aria-label":r,className:"mb-20 mt-10",type:"password",value:i,required:!0,errorMessage:l&&e.jsx(p,{message:"Password is not valid"}),onChange:t=>{o(t.target.value)}}),e.jsx("div",{className:"text-right",children:e.jsx(A,{variant:"flat",color:"primary",type:"submit",className:"w-full md:w-auto",disabled:n.isPending,children:e.jsx(p,{message:"Enter"})})})]})]})})]})}function Xe(){const{link:s}=x();return s!=null&&s.entry?e.jsxs("div",{className:"flex h-screen flex-col bg-alt",children:[e.jsx(O,{}),e.jsx($,{slot:"file-preview",className:"mx-auto mt-24"}),e.jsx(De,{entries:[s.entry],showHeader:!1,allowDownload:s.allow_download})]}):null}function As(){var d;const{status:s,link:a}=x(),{trans:r}=q(),i=m(l=>l.isPasswordProtected),o=m(l=>l.password);let n;if(s==="pending")n=e.jsx("div",{className:"flex h-screen flex-auto items-center justify-center",children:e.jsx(b,{"aria-label":r({message:"Loading link"}),isIndeterminate:!0})});else{if(!a&&!i)return e.jsx(fe,{});i&&!o?n=e.jsx(Ye,{}):((d=a==null?void 0:a.entry)==null?void 0:d.type)==="folder"?n=e.jsx(Ue,{}):n=e.jsx(Xe,{})}return e.jsx(ge,{children:e.jsx(ke.Provider,{value:{shareable_link:a==null?void 0:a.id,password:o},children:n})})}export{As as Component};
