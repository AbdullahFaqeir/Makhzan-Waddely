{"version":3,"file":"use-normalized-models-Cb3k3qGb.js","sources":["../../../common/foundation/resources/client/ui/normalized-model/use-normalized-models.ts"],"sourcesContent":["import {\n  keepPreviousData,\n  useQuery,\n  UseQueryOptions,\n} from '@tanstack/react-query';\nimport {NormalizedModel} from '@ui/types/normalized-model';\nimport {BackendResponse} from '../../http/backend-response/backend-response';\nimport {apiClient, queryClient} from '../../http/query-client';\n\ninterface Response extends BackendResponse {\n  results: NormalizedModel[];\n}\n\ninterface Params {\n  query?: string;\n  perPage?: number;\n  with?: string;\n  modelIds?: string;\n}\n\nexport function useNormalizedModels(\n  endpoint: string,\n  queryParams?: Params,\n  queryOptions?: Omit<\n    UseQueryOptions<Response, unknown, Response, any[]>,\n    'queryKey' | 'queryFn'\n  > | null,\n) {\n  const {queryKey, params} = buildQueryKeyAndParams(endpoint, queryParams);\n  return useQuery({\n    queryKey,\n    queryFn: () => fetchModels(endpoint, params),\n    placeholderData: keepPreviousData,\n    ...queryOptions,\n  });\n}\n\nexport function prefetchNormalizedModels(\n  endpoint: string,\n  queryParams?: Params,\n) {\n  const {queryKey, params} = buildQueryKeyAndParams(endpoint, queryParams);\n  return queryClient.ensureQueryData({\n    queryKey,\n    queryFn: () => fetchModels(endpoint, params),\n  });\n}\n\nasync function fetchModels(endpoint: string, params?: Params) {\n  return apiClient.get<Response>(endpoint, {params}).then(r => {\n    if ('results' in r.data) {\n      return r.data;\n    } else {\n      const results = Object.values(r.data).find(v => Array.isArray(v));\n      return {results} as Response;\n    }\n  });\n}\n\nfunction buildQueryKeyAndParams(endpoint: string, queryParams?: Params) {\n  // normalize query params, so different query keys are not generated\n  if (queryParams && queryParams.query === '') {\n    delete queryParams.query;\n  }\n\n  const endpointParts = endpoint.split('/');\n  // last part will be resource name most like (eg. 'normalized-models/users')\n  // we will want to put 'users' as first part of query key so that doing\n  // queryClient.invalidate(['users']) will invalidate normalzied models as well\n  const resourceName = endpointParts.pop() as string;\n\n  const queryKey: (string | Params)[] = [resourceName, ...endpointParts];\n\n  if (queryParams && Object.keys(queryParams).length) {\n    queryKey.push(queryParams);\n  }\n\n  return {queryKey, params: queryParams};\n}\n"],"names":["useNormalizedModels","endpoint","queryParams","queryOptions","queryKey","params","buildQueryKeyAndParams","useQuery","fetchModels","keepPreviousData","apiClient","r","v","endpointParts"],"mappings":"sDAoBO,SAASA,EACdC,EACAC,EACAC,EAIA,CACA,KAAM,CAAC,SAAAC,EAAU,OAAAC,CAAA,EAAUC,EAAuBL,EAAUC,CAAW,EACvE,OAAOK,EAAS,CACd,SAAAH,EACA,QAAS,IAAMI,EAAYP,EAAUI,CAAM,EAC3C,gBAAiBI,EACjB,GAAGN,CAAA,CACJ,CACH,CAaA,eAAeK,EAAYP,EAAkBI,EAAiB,CAC5D,OAAOK,EAAU,IAAcT,EAAU,CAAC,OAAAI,EAAO,EAAE,KAAKM,GAClD,YAAaA,EAAE,KACVA,EAAE,KAGF,CAAC,QADQ,OAAO,OAAOA,EAAE,IAAI,EAAE,KAAKC,GAAK,MAAM,QAAQA,CAAC,CAAC,CACxD,CAEX,CACH,CAEA,SAASN,EAAuBL,EAAkBC,EAAsB,CAElEA,GAAeA,EAAY,QAAU,IACvC,OAAOA,EAAY,MAGrB,MAAMW,EAAgBZ,EAAS,MAAM,GAAG,EAMlCG,EAAgC,CAFjBS,EAAc,IAAA,EAEkB,GAAGA,CAAa,EAErE,OAAIX,GAAe,OAAO,KAAKA,CAAW,EAAE,QAC1CE,EAAS,KAAKF,CAAW,EAGpB,CAAC,SAAAE,EAAU,OAAQF,CAAA,CAC5B"}