{"version":3,"file":"permission-selector-OMlsip5c.js","sources":["../../../common/foundation/resources/client/auth/ui/permission-selector.tsx"],"sourcesContent":["import {commonAdminQueries} from '@common/admin/common-admin-queries';\nimport {mergeProps} from '@react-aria/utils';\nimport {useControlledState} from '@react-stately/utils';\nimport {useQuery} from '@tanstack/react-query';\nimport {Accordion, AccordionItem} from '@ui/accordion/accordion';\nimport {TextField} from '@ui/forms/input-field/text-field/text-field';\nimport {Switch} from '@ui/forms/toggle/switch';\nimport {Trans} from '@ui/i18n/trans';\nimport {DoneAllIcon} from '@ui/icons/material/DoneAll';\nimport {List, ListItem} from '@ui/list/list';\nimport {ucFirst} from '@ui/utils/string/uc-first';\nimport clsx from 'clsx';\nimport {produce} from 'immer';\nimport React, {Fragment} from 'react';\nimport {useController} from 'react-hook-form';\nimport {Permission, PermissionRestriction} from '../permission';\n\ninterface PermissionSelectorProps {\n  value?: Permission[];\n  onChange?: (value: Permission[]) => void;\n  type?: string;\n}\nexport const PermissionSelector = React.forwardRef<\n  HTMLDivElement,\n  PermissionSelectorProps\n>(({type, ...props}, ref) => {\n  const query = useQuery(commonAdminQueries.permissions.index());\n  const permissions = query.data?.permissions;\n\n  const [value, setValue] = useControlledState(props.value, [], props.onChange);\n\n  if (!permissions) return null;\n\n  const groupedPermissions = buildPermissionList(permissions, value, type);\n\n  const onRestrictionChange = (newPermission: Permission) => {\n    const newValue = [...value];\n    const index = newValue.findIndex(p => p.id === newPermission.id);\n    if (index > -1) {\n      newValue.splice(index, 1, newPermission);\n    }\n    setValue(newValue);\n  };\n\n  return (\n    <Fragment>\n      <Accordion variant=\"outline\" ref={ref}>\n        {groupedPermissions.map(({groupName, items, anyChecked}) => (\n          <AccordionItem\n            label={<Trans message={prettyName(groupName)} />}\n            key={groupName}\n            startIcon={anyChecked ? <DoneAllIcon size=\"sm\" /> : undefined}\n          >\n            <List>\n              {items.map(permission => {\n                const index = value.findIndex(v => v.id === permission.id);\n                const isChecked = index > -1;\n\n                return (\n                  <div key={permission.id}>\n                    <ListItem\n                      onSelected={() => {\n                        if (isChecked) {\n                          const newValue = [...value];\n                          newValue.splice(index, 1);\n                          setValue(newValue);\n                        } else {\n                          setValue([...value, permission]);\n                        }\n                      }}\n                      endSection={\n                        <Switch\n                          tabIndex={-1}\n                          checked={isChecked}\n                          onChange={() => {}}\n                        />\n                      }\n                      description={<Trans message={permission.description} />}\n                    >\n                      <Trans message={permission.display_name} />\n                    </ListItem>\n                    {isChecked && (\n                      <Restrictions\n                        permission={permission}\n                        onChange={onRestrictionChange}\n                      />\n                    )}\n                  </div>\n                );\n              })}\n            </List>\n          </AccordionItem>\n        ))}\n      </Accordion>\n    </Fragment>\n  );\n});\n\ninterface RestrictionsProps {\n  permission: Permission;\n  onChange?: (newPermission: Permission) => void;\n}\nfunction Restrictions({permission, onChange}: RestrictionsProps) {\n  if (!permission?.restrictions?.length) return null;\n\n  const setRestrictionValue = (\n    name: string,\n    value: PermissionRestriction['value'],\n  ) => {\n    const nextState = produce(permission, draftState => {\n      const restriction = draftState.restrictions.find(r => r.name === name);\n      if (restriction) {\n        restriction.value = value;\n      }\n    });\n    onChange?.(nextState);\n  };\n\n  return (\n    <div className=\"px-40 py-20\">\n      {permission.restrictions.map((restriction, index) => {\n        const isLast = index === permission.restrictions.length - 1;\n\n        const name = (\n          <Trans\n            message={\n              restriction.display_name\n                ? restriction.display_name\n                : prettyName(restriction.name)\n            }\n          />\n        );\n        const description = restriction.description ? (\n          <Trans message={restriction.description} />\n        ) : undefined;\n\n        if (restriction.type === 'bool') {\n          return (\n            <Switch\n              description={description}\n              key={restriction.name}\n              className={clsx(!isLast && 'mb-30')}\n              checked={Boolean(restriction.value)}\n              onChange={e => {\n                setRestrictionValue(restriction.name, e.target.checked);\n              }}\n            >\n              {name}\n            </Switch>\n          );\n        }\n\n        return (\n          <TextField\n            size=\"sm\"\n            label={name}\n            description={description}\n            type=\"number\"\n            key={restriction.name}\n            className={clsx(!isLast && 'mb-30')}\n            value={(restriction.value as string) || ''}\n            onChange={e => {\n              setRestrictionValue(\n                restriction.name,\n                e.target.value === '' ? undefined : parseInt(e.target.value),\n              );\n            }}\n          />\n        );\n      })}\n    </div>\n  );\n}\n\nexport type FormChipFieldProps = PermissionSelectorProps & {\n  name: string;\n};\nexport function FormPermissionSelector(props: FormChipFieldProps) {\n  const {\n    field: {onChange, value = [], ref},\n  } = useController({\n    name: props.name,\n  });\n\n  const formProps: Partial<PermissionSelectorProps> = {\n    onChange,\n    value,\n  };\n\n  return <PermissionSelector ref={ref} {...mergeProps(formProps, props)} />;\n}\n\nexport const prettyName = (name: string) => {\n  return ucFirst(name.replace('_', ' '));\n};\n\ninterface PermissionGroup {\n  groupName: string;\n  anyChecked: boolean;\n  items: Permission[];\n}\n\n// merge \"restrictions\" from selected value into all permissions to make\n// it easier to bind restriction values to form inputs\nexport function buildPermissionList(\n  allPermissions: Permission[],\n  selectedPermissions: Permission[],\n  type: string = 'users',\n) {\n  const groupedPermissions: PermissionGroup[] = [];\n\n  allPermissions.forEach(permission => {\n    const permissionType = permission.type || 'users';\n    if (permissionType !== type) return;\n\n    let group = groupedPermissions.find(g => g.groupName === permission.group);\n    if (!group) {\n      group = {groupName: permission.group, anyChecked: false, items: []};\n      groupedPermissions.push(group);\n    }\n\n    const index = selectedPermissions.findIndex(p => p.id === permission.id);\n    if (index > -1) {\n      const mergedPermission = {\n        ...permission,\n        restrictions: mergeRestrictions(\n          permission.restrictions,\n          selectedPermissions[index].restrictions,\n        ),\n      };\n      group.anyChecked = true;\n      group.items.push(mergedPermission);\n    } else {\n      group.items.push(permission);\n    }\n  });\n\n  return groupedPermissions;\n}\n\nfunction mergeRestrictions(\n  allRestrictions: PermissionRestriction[],\n  selectedRestrictions: PermissionRestriction[],\n): PermissionRestriction[] {\n  return allRestrictions?.map(restriction => {\n    const selected = selectedRestrictions?.find(\n      r => r.name === restriction.name,\n    );\n    if (selected) {\n      return {...restriction, value: selected.value};\n    } else {\n      return restriction;\n    }\n  });\n}\n"],"names":["PermissionSelector","React","type","props","ref","permissions","_a","useQuery","commonAdminQueries","value","setValue","useControlledState","groupedPermissions","buildPermissionList","onRestrictionChange","newPermission","newValue","index","p","jsx","Fragment","Accordion","groupName","items","anyChecked","AccordionItem","Trans","prettyName","DoneAllIcon","List","permission","v","isChecked","ListItem","Switch","Restrictions","onChange","setRestrictionValue","name","nextState","produce","draftState","restriction","r","isLast","description","clsx","e","TextField","FormPermissionSelector","useController","formProps","mergeProps","ucFirst","allPermissions","selectedPermissions","group","g","mergedPermission","mergeRestrictions","allRestrictions","selectedRestrictions","selected"],"mappings":"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"}